<!DOCTYPE html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title><%= title %></title> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"> 
    <link rel="stylesheet" href="/css/style.css"> 
    <style> 
    :root { 
        --primary-blue: #0077be; 
        --secondary-blue: #00a2e8; 
        --dark-blue: #003366; 
        --light-blue: #e6f2ff;
        --message-blue: #1c93e3;
        --bg-light: #f5f7fb;
        --border-light: #e9ecef;
        --footer-blue: #002347; /* Dark blue for footer */
    }

    body {
        background-color: #f8f9fa;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .content-wrapper {
        flex: 1 0 auto;
    }

    /* Page header styles */
    .page-header {
        padding: 15px 0;
        margin-bottom: 20px;
    }

    .back-link {
        color: var(--primary-blue);
        text-decoration: none;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 1rem;
    }

    .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
        color: #333;
        text-align: center;
    }

    /* Main container */
    .chat-wrapper {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        overflow: hidden;
        height: calc(100vh - 220px);
        margin-bottom: 30px;
    }

    /* Conversation List Styling */
    .conversations-list {
        height: 100%;
        overflow-y: auto;
        border-right: 1px solid var(--border-light);
    }

    .conversation-card {
        border-radius: 0;
        border: none;
        border-bottom: 1px solid var(--border-light);
        margin-bottom: 0;
        transition: all 0.2s ease;
        cursor: pointer;
        padding: 15px 20px;
    }
  
    .conversation-card:hover {
        background-color: rgba(0,0,0,0.02);
    }

    .conversation-card.active {
        background-color: var(--light-blue);
        border-left: 3px solid var(--primary-blue);
    }
    
    .provider-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .provider-avatar {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        background-color: var(--light-blue);
        color: var(--dark-blue);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: 600;
        flex-shrink: 0;
    }
    
    .provider-name {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .last-message {
        color: #666;
        font-size: 0.85rem;
        margin-bottom: 5px;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .conversation-time {
        font-size: 0.75rem;
        color: #888;
    }
    
    .unread-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background-color: #ff3b30;
        color: white;
        font-size: 0.75rem;
        border-radius: 50%;
        min-width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
        font-weight: bold;
    }

    /* Chat Styling */
    .chat-container {
        height: 100%;
        display: flex;
        flex-direction: column;
        background-color: white;
    }
    
    .chat-header {
        background-color: white;
        color: #333;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--border-light);
    }
    
    .chat-header h2 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        background-color: var(--bg-light);
    }
    
    .message {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 20px;
        position: relative;
        word-break: break-word;
        margin-bottom: 2px;
        line-height: 1.4;
    }
    
    .message-outgoing {
        align-self: flex-end;
        background-color: var(--message-blue);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message-outgoing .read-status {
        margin-top: 4px;
        color: rgba(255,255,255,0.7);
    }

    .message-content {
        margin-bottom: 2px;
    }
    
    .message-incoming {
        align-self: flex-start;
        background-color: white;
        color: #333;
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* Message attachment styling */
    .message-image {
        border-radius: 12px;
        overflow: hidden;
        max-width: 250px;
        max-height: 200px;
        display: block;
        margin-top: 6px;
        border: 1px solid rgba(0,0,0,0.1);
    }

    .message-outgoing .message-image {
        border: 1px solid rgba(255,255,255,0.3);
    }
    
    .chat-input {
        padding: 15px 20px;
        background-color: white;
        border-top: 1px solid var(--border-light);
    }
    
    .chat-input .input-group {
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-radius: 24px;
        background-color: white;
        overflow: hidden;
        width: 100%; /* Ensure full width */
        display: flex;
    }

    /* Ensure the attachment button has fixed width */
    .chat-input .btn-attachment {
        background-color: transparent;
        color: #999;
        border-radius: 0;
        padding: 0 15px;
        border-right: 1px solid #eee;
        flex-shrink: 0; /* Prevent from shrinking */
        width: auto;
        min-width: 50px;
    }

    .message-time {
        font-size: 0.7rem;
        color: rgba(0,0,0,0.5);
        text-align: right;
        margin-top: 4px;
    }

    .message-outgoing .message-time {
        color: rgba(0, 0, 0, 0.7);
    }

    .chat-input .btn-primary {
        background-color: var(--message-blue);
        border-radius: 0 24px 24px 0;
        padding: 0 20px;
        flex-shrink: 0; /* Prevent from shrinking */
        width: auto;
        min-width: 60px;
    }

    .chat-input .form-control {
        flex: 1 1 auto; /* Allow input to grow and shrink as needed */
        min-width: 0; /* Critical for proper flexbox behavior */
        border: none;
        padding: 12px 20px;
        background-color: white;
        font-size: 0.95rem;
    }
    
    .chat-input input {
        border: none;
        padding: 12px 20px;
        background-color: white;
        font-size: 0.95rem;
    }
    
    .chat-input input:focus {
        box-shadow: none;
    }

    /* Updated button styles for repositioning attachment icon */
    .chat-input .input-group-append {
        display: flex;
    }
    
    .chat-input button {
        border: none;
        transition: all 0.2s ease;
    }
    
    .chat-input button.btn-primary {
        background-color: var(--message-blue);
        border-radius: 0 24px 24px 0;
        padding: 0 20px;
    }

    .chat-input button.btn-attachment {
        background-color: transparent;
        color: #999;
        border-radius: 0;
        padding: 0 15px;
        border-right: 1px solid #eee;
    }
    
    .chat-input button:hover {
        opacity: 0.9;
    }
    
    .read-status {
        font-size: 0.7rem;
        text-align: right;
        font-weight: 300;
    }
    
    .read-status.read {
        color: #000000;
    }
    
    .read-status.unread {
        color: #000000;
    }
    
    .typing-indicator {
        display: none;
        align-self: flex-start;
        background-color: white;
        color: #333;
        border-radius: 18px;
        padding: 8px 15px;
        font-size: 0.9rem;
        margin-top: 8px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .typing-indicator span {
        display: inline-block;
        width: 6px;
        height: 6px;
        background-color: #666;
        border-radius: 50%;
        animation: typing 1s infinite;
        margin: 0 1px;
    }
    
    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-5px);
        }
    }

    /* Empty chat state */
    .empty-chat {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        padding: 20px;
        text-align: center;
        color: #888;
        background-color: var(--bg-light);
    }

    .empty-chat i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #ccc;
    }

    .empty-chat.hidden {
        display: none;
    }

    /* Show/hide chat container */
    .chat-container {
        display: none;
    }

    .chat-container.active {
        display: flex;
    }

    /* Conversation list empty state */
    .no-conversations {
        padding: 30px 20px;
        text-align: center;
        color: #666;
    }

    .no-conversations i {
        font-size: 3rem;
        color: #ddd;
        margin-bottom: 15px;
    }

    /* Image preview */
    #image-preview-container {
        background-color: rgba(0,0,0,0.03);
        border-radius: 12px;
        padding: 10px;
        margin-top: 10px;
    }

    #image-preview {
        border-radius: 8px;
    }

    /* Bold styling for unread conversations */
    .conversation-card.has-unread .provider-name {
        font-weight: 700;
        color: #000;
    }

    .conversation-card.has-unread .last-message {
        font-weight: 600;
        color: #333;
    }

    /* Highlight active chat when there are new unread messages */
    .chat-container.has-new-messages {
        border: 2px solid #ff3b30;
    }

    /* Subtle highlight for new incoming messages */
    .message-incoming.new-message {
        animation: highlightNew 2s ease-out;
    }

    @keyframes highlightNew {
        0% {
            background-color: rgba(0, 119, 190, 0.1);
        }
        100% {
            background-color: white;
        }
    }

    /* Footer styling to match the first image */
    .site-footer {
        background-color: var(--footer-blue);
        color: white;
        padding: 40px 0 20px;
        margin-top: auto;
    }

    .footer-heading {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 20px;
    }

    .footer-text {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .footer-link {
        color: white;
        text-decoration: none;
        display: block;
        margin-bottom: 10px;
        transition: all 0.2s ease;
    }

    .footer-link:hover {
        color: var(--secondary-blue);
    }

    .footer-icon {
        margin-right: 10px;
        width: 18px;
    }

    .footer-social {
        display: flex;
        gap: 15px;
        margin-top: 15px;
    }

    .footer-social a {
        color: white;
        font-size: 1.2rem;
        transition: all 0.2s ease;
    }

    .footer-social a:hover {
        color: var(--secondary-blue);
    }

    .footer-bottom {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 20px;
        margin-top: 30px;
        font-size: 0.85rem;
    }

    .footer-bottom-links {
        text-align: right;
    }

    .footer-bottom-links a {
        color: rgba(255, 255, 255, 0.8);
        margin-left: 20px;
        text-decoration: none;
    }

    .footer-bottom-links a:hover {
        color: white;
    }

    /* Media queries */
    @media (max-width: 992px) {
        .chat-wrapper {
            border-radius: 0;
            height: calc(100vh - 180px);
        }
        
        .conversations-col {
            display: none;
        }
        
        .conversations-col.active {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            background-color: white;
        }
        
        .chat-container {
            border-radius: 0;
        }

        .footer-bottom-links {
            text-align: center;
            margin-top: 15px;
        }

        .footer-bottom-links a {
            margin: 0 10px;
        }
    }
    </style> 
</head> 

<body> 
<%- include('../partials/navbar') %>

<div class="content-wrapper">
    <div class="container py-4">
        <!-- Simple header without card styling -->
        <div class="page-header d-flex justify-content-between align-items-center">
            <a href="/customer/dashboard" class="back-link">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
            <!-- <h1 class="page-title">My Conversations</h1> -->
            <div style="width: 150px;"></div>
        </div>

        <% if (locals.error) { %>
            <div class="alert alert-danger" role="alert">
                <%= error %>
            </div>
        <% } %>
        
        <% if (locals.success) { %>
            <div class="alert alert-success" role="alert">
                <%= success %>
            </div>
        <% } %>
        
        <!-- Main chat interface -->
        <div class="chat-wrapper">
            <div class="row g-0 h-100">
                <!-- Conversation list column -->
                <div class="col-lg-4 conversations-col h-100">
                    <!-- Conversation List -->
                    <div class="conversations-list">
                    <% if (conversations && conversations.length > 0) { %>
                        <% conversations.forEach(conv => { %>
                            <div class="conversation-card <%= activeProvider && activeProvider.id == conv.provider_id ? 'active' : '' %> <%= parseInt(conv.unread_count) > 0 ? 'has-unread' : '' %>" 
                                data-provider-id="<%= conv.provider_id %>" 
                                data-unread="<%= conv.unread_count %>"
                                onclick="window.location.href='/customer/conversations?provider=<%= conv.provider_id %>'">
                                <div class="provider-info">
                                    <div class="provider-avatar">
                                        <%= conv.provider_name.charAt(0).toUpperCase() %>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="provider-name">
                                            <%= conv.provider_name %>
                                            <% if (conv.is_verified) { %>
                                                <i class="bi bi-check-circle-fill text-primary ms-1" title="Verified Provider" style="font-size: 0.75rem;"></i>
                                            <% } %>
                                        </div>
                                        <div class="last-message">
                                            <% if (conv.last_message_has_attachment && (!conv.last_message || conv.last_message.trim() === '')) { %>
                                                <% if (conv.last_message_attachment_type && conv.last_message_attachment_type.startsWith('image/')) { %>
                                                    ðŸ“· Image
                                                <% } else { %>
                                                    ðŸ“Ž File attachment
                                                <% } %>
                                            <% } else { %>
                                                <%= conv.last_message || 'No messages yet' %>
                                            <% } %>
                                        </div>
                                        <div class="conversation-time">
                                            <% if (conv.last_message_time) { %>
                                                <% 
                                                    // Convert to Malaysian timezone
                                                    const msgDate = new Date(conv.last_message_time);
                                                    
                                                    // Format date for Malaysian timezone
                                                    const malaysianTimeFormatter = new Intl.DateTimeFormat('en-MY', {
                                                        timeZone: 'Asia/Kuala_Lumpur',
                                                        hour: '2-digit',
                                                        minute: '2-digit',
                                                        hour12: true
                                                    });
                                                    
                                                    // Get today and yesterday dates in Malaysian timezone
                                                    const now = new Date();
                                                    const malaysianNow = new Date(now.toLocaleString('en-US', {timeZone: 'Asia/Kuala_Lumpur'}));
                                                    
                                                    const yesterday = new Date();
                                                    yesterday.setDate(now.getDate() - 1);
                                                    const malaysianYesterday = new Date(yesterday.toLocaleString('en-US', {timeZone: 'Asia/Kuala_Lumpur'}));
                                                    
                                                    // Convert message date to Malaysian time for comparison
                                                    const malaysianMsgDate = new Date(msgDate.toLocaleString('en-US', {timeZone: 'Asia/Kuala_Lumpur'}));
                                                    
                                                    const isToday = malaysianNow.getDate() === malaysianMsgDate.getDate() &&
                                                                malaysianNow.getMonth() === malaysianMsgDate.getMonth() &&
                                                                malaysianNow.getFullYear() === malaysianMsgDate.getFullYear();
                                                    
                                                    const isYesterday = malaysianYesterday.getDate() === malaysianMsgDate.getDate() &&
                                                                    malaysianYesterday.getMonth() === malaysianMsgDate.getMonth() &&
                                                                    malaysianYesterday.getFullYear() === malaysianMsgDate.getFullYear();
                                                    
                                                    if (isToday) {
                                                        // Show time only if today
                                                        %><i class="bi bi-clock"></i> <%= malaysianTimeFormatter.format(msgDate) %><%
                                                    } else if (isYesterday) {
                                                        // Show "Yesterday" if yesterday
                                                        %><i class="bi bi-calendar-check"></i> Yesterday<%
                                                    } else {
                                                        // Show date otherwise
                                                        const dateFormatter = new Intl.DateTimeFormat('en-MY', {
                                                            timeZone: 'Asia/Kuala_Lumpur',
                                                            year: 'numeric',
                                                            month: 'short',
                                                            day: 'numeric'
                                                        });
                                                        
                                                        %><i class="bi bi-calendar"></i> <%= dateFormatter.format(msgDate) %><%
                                                    }
                                                %>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                                <% if (parseInt(conv.unread_count) > 0) { %>
                                    <div class="unread-badge">
                                        <%= conv.unread_count %>
                                    </div>
                                <% } %>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="no-conversations">
                            <i class="bi bi-chat-dots"></i>
                            <h4>No conversations yet</h4>
                            <p class="text-muted">Start a conversation with a service provider by visiting their profile.</p>
                        </div>
                    <% } %>
                    </div>
                </div>
                
                <!-- Chat column -->
                <div class="col-lg-8 h-100">
                    <!-- Empty State (shown when no conversation is selected) -->
                    <div class="empty-chat <%= activeProvider ? 'hidden' : '' %>" id="empty-chat">
                        <i class="bi bi-chat-square-text"></i>
                        <h3>Select a conversation</h3>
                        <p>Choose a conversation from the list to start chatting with a service provider</p>
                    </div>
                    
                    <!-- Active Chat -->
                    <div class="chat-container <%= activeProvider ? 'active' : '' %>" id="chat-container">
                        <% if (activeProvider) { %>
                            <div class="chat-header">
                                <div class="provider-info">
                                    <div class="provider-avatar">
                                        <%= activeProvider.business_name.charAt(0).toUpperCase() %>
                                    </div>
                                    <h2>
                                        <%= activeProvider.business_name %>
                                        <% if (activeProvider.is_verified) { %>
                                            <i class="bi bi-check-circle-fill text-primary ms-1" title="Verified Provider" style="font-size: 0.8rem;"></i>
                                        <% } %>
                                    </h2>
                                </div>
                                <div>
                                    <a href="/customer/provider/<%= activeProvider.id %>" class="btn btn-sm btn-outline-primary rounded-pill">
                                        <i class="bi bi-info-circle"></i> View Profile
                                    </a>
                                </div>
                            </div>
                            
                            <div class="chat-messages" id="chat-messages">
                                <% if (messages && messages.length > 0) { %>
                                    <% messages.forEach(message => { %>
                                        <div class="message <%= message.sender_type === 'customer' ? 'message-outgoing' : 'message-incoming' %>">
                                                <% if (message.message_text) { %>
                                                    <div class="message-content"><%= message.message_text %></div>
                                                <% } %>
                                                
                                                <% if (message.has_attachment && message.attachment_url) { %>
                                                    <% const isImage = message.attachment_type && message.attachment_type.startsWith('image/'); %>
                                                    <% if (isImage) { %>
                                                        <div class="message-attachment">
                                                            <img src="<%= message.attachment_url %>" class="message-image" alt="Image attachment">
                                                        </div>
                                                    <% } else { %>
                                                        <div class="message-attachment">
                                                            <a href="<%= message.attachment_url %>" class="btn btn-sm btn-outline-secondary" target="_blank">
                                                                <i class="bi bi-paperclip"></i> <%= message.attachment_name || 'Attachment' %>
                                                            </a>
                                                        </div>
                                                    <% } %>
                                                <% } %>

                                                <!-- Add timestamp to each message -->
                                                <div class="message-time">
                                                    <%= new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
                                                </div>
                            
                                            
                                            
                                            <% if (message.sender_type === 'customer') { %>
                                                <div class="read-status <%= message.is_read ? 'read' : 'unread' %>">
                                                    <%= message.is_read ? 'Read' : 'Delivered' %>
                                                </div>
                                            <% } %>
                                        </div>
                                    <% }); %>
                                <% } else { %>
                                    <div class="text-center text-muted my-4">
                                        <p>No messages yet. Start the conversation!</p>
                                    </div>
                                <% } %>
                                <div class="typing-indicator" id="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                            
                            <!-- Updated chat input with repositioned attachment button -->
                           <div class="chat-input">
                                <form id="message-form" data-conversation-id="<%= conversationId %>">
                                    <!-- Hidden file input -->
                                    <input type="file" id="image-upload" name="attachment" style="display: none;" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx">
                                    
                                    <div class="input-group w-100"> <!-- Added w-100 for full width -->
                                        <div class="input-group-append d-flex"> <!-- Use d-flex to ensure proper alignment -->
                                            <!-- Paperclip attachment button (positioned on the left) -->
                                            <button type="button" class="btn btn-attachment" id="attachment-button" title="Attach image">
                                                <i class="bi bi-paperclip"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Message input - fill all available space -->
                                        <input type="text" id="message-input" class="form-control flex-grow-1" placeholder="Type your message..." autocomplete="off">
                                        
                                        <!-- Send button -->
                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-send-fill"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Image preview container (hidden by default) -->
                                    <div id="image-preview-container" class="d-none mt-2">
                                        <div class="position-relative d-inline-block">
                                            <img id="image-preview" class="rounded border" style="max-height: 100px; max-width: 200px; object-fit: contain;">
                                            <button type="button" id="remove-image" class="btn btn-sm btn-danger position-absolute" style="top: -10px; right: -10px; border-radius: 50%; width: 24px; height: 24px; padding: 0;">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<%- include('../partials/footer') %>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<!-- Replace Socket.IO with Pusher -->
<script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
<script>

document.addEventListener('DOMContentLoaded', function() {
    <% if (activeProvider) { %>
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const chatContainer = document.getElementById('chat-container');
        const conversationId = '<%= conversationId %>';
        let lastMessageId = '<%= messages && messages.length > 0 ? messages[messages.length - 1].id : 0 %>';
        let typingTimeout;
        let hasSeenNewMessages = true; // Track if user has seen all new messages
        
        // Function to detect if a URL is a Cloudinary URL
        function isCloudinaryUrl(url) {
            return url && (url.includes('cloudinary.com') || url.includes('res.cloudinary.com'));
        }

        // Function to optimize Cloudinary image URLs for different purposes
        function optimizeCloudinaryUrl(url, type) {
            if (!isCloudinaryUrl(url)) return url;
            
            // Extract the base URL without transformation parameters
            let baseUrl = url;
            
            if (url.includes('/upload/')) {
                // Split at /upload/ to insert transformations
                const parts = url.split('/upload/');
                
                switch(type) {
                    case 'thumbnail':
                        // Small thumbnail for conversation list
                        return `${parts[0]}/upload/c_fill,w_100,h_100,g_auto/${parts[1]}`;
                    
                    case 'preview':
                        // Medium size for image preview before sending
                        return `${parts[0]}/upload/c_scale,w_300/${parts[1]}`;
                    
                    case 'chat':
                        // For images in chat messages
                        return `${parts[0]}/upload/c_limit,w_500,h_400/${parts[1]}`;
                    
                    case 'fullsize':
                        // For viewing the full image
                        return `${parts[0]}/upload/q_auto,f_auto/${parts[1]}`;
                        
                    default:
                        return url;
                }
            }
            
            return url;
        }

        // **PUSHER CONFIGURATION**
        const pusher = new Pusher('<%= pusherKey %>', {
            cluster: '<%= pusherCluster %>',
            encrypted: true,
            authEndpoint: '/pusher/auth',
            auth: {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }
        });

        // Subscribe to conversation channel
        const conversationChannel = pusher.subscribe(`conversation-${conversationId}`);
        
        // Subscribe to customer notification channel  
        const userId = '<%= user.id %>';
        const userChannel = pusher.subscribe(`user-customer-${userId}`);
        
        // Check if page is visible
        let pageIsVisible = !document.hidden;
        
        document.addEventListener('visibilitychange', function() {
            pageIsVisible = !document.hidden;
            
            // If page becomes visible, reset new message indicator
            if (pageIsVisible) {
                hasSeenNewMessages = true;
                chatContainer.classList.remove('has-new-messages');
            }
        });
        
        // **PUSHER EVENT HANDLERS**
        
        // Handle incoming messages
        conversationChannel.bind('new-message', function(data) {
            console.log('Pusher: received message', data);
            if (data.sender_type === 'provider') {
                // Add with new message styling
                if (data.has_attachment) {
                    if (data.attachment_type && data.attachment_type.startsWith('image/')) {
                        addImageMessage(data, false, true);
                    } else {
                        addDocumentMessage(data, false);
                    }
                } else {
                    addMessage(data, false, true);
                }
                
                // If user is looking at the page, mark as read
                if (pageIsVisible) {
                    hasSeenNewMessages = true;
                    fetch('/api/mark-messages-read', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            conversationId: conversationId
                        }),
                    }).catch(error => {
                        console.error('Error marking messages as read:', error);
                    });
                } else {
                    // Otherwise indicate new message
                    hasSeenNewMessages = false;
                    chatContainer.classList.add('has-new-messages');
                    
                    // Update page title with notification
                    document.title = `(New) My Conversations`;
                    
                    // Play notification sound if available
                    playNotificationSound();
                }
            }
            
            // Hide typing indicator
            typingIndicator.style.display = 'none';
        });

        // Handle read receipts
        conversationChannel.bind('messages-read', function(data) {
            console.log('Pusher: messages read', data);
            if (data.readBy === 'provider') {
                // Update read status for all outgoing messages
                const messages = document.querySelectorAll('.message.message-outgoing');
                messages.forEach(message => {
                    const readStatus = message.querySelector('.read-status');
                    if (readStatus) {
                        readStatus.textContent = 'Read';
                        readStatus.classList.remove('unread');
                        readStatus.classList.add('read');
                    }
                });
            }
        });

        // Handle message notifications (for other conversations)
        userChannel.bind('message-notification', function(data) {
            console.log('Pusher: message notification', data);
            // Update unread count badge
            checkUnreadCount();
        });
        
        // Play notification sound
        function playNotificationSound() {
            try {
                const audio = new Audio('/notification.mp3');
                audio.play();
            } catch (e) {
                console.log('Notification sound not available');
            }
        }
        
        // Submit message form
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Check if there's a file or text message
            const message = messageInput.value.trim();
            const fileInput = document.getElementById('image-upload');
            const file = fileInput ? fileInput.files[0] : null;

            if (!message && !file) return;
            
            // If there's a file, handle it with the file upload function
            if (file) {
                uploadFileWithMessage(file, message);
                return;
            }
            
            // Otherwise, send as a text-only message
            console.log('Sending message:', message, 'to conversation:', conversationId);
            
            // Send message via API
            fetch('/api/send-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    conversationId: conversationId,
                    message: message,
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('API response:', data);
                if (data.success) {
                    // Add message to chat
                    addMessage(data.message, true);
                    
                    // Clear input
                    messageInput.value = '';
                } else {
                    console.error('Error sending message:', data.error);
                    alert('Failed to send message: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Failed to send message. Please try again.');
            });
        });
        
        // Upload file with optional message text
        function uploadFileWithMessage(file, messageText) {
            if (!file) return;
            
            // Validate file size
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB.');
                return;
            }
            
            // Create FormData
            const formData = new FormData();
            formData.append('conversationId', conversationId);
            formData.append('message', messageText || '');
            formData.append('attachment', file);
            
            // Create temporary message with loading indicator
            const tempMsg = document.createElement('div');
            tempMsg.classList.add('message', 'message-outgoing', 'temp-message');
            
            // Determine icon based on file type
            let uploadingIcon;
            let uploadingText;
            
            if (file.type.startsWith('image/')) {
                uploadingIcon = 'bi-image';
                uploadingText = 'Uploading image...';
            } else if (file.type.includes('pdf')) {
                uploadingIcon = 'bi-file-pdf';
                uploadingText = 'Uploading PDF...';
            } else if (file.type.includes('word') || file.type.includes('doc')) {
                uploadingIcon = 'bi-file-word';
                uploadingText = 'Uploading document...';
            } else if (file.type.includes('excel') || file.type.includes('sheet')) {
                uploadingIcon = 'bi-file-excel';
                uploadingText = 'Uploading spreadsheet...';
            } else {
                uploadingIcon = 'bi-file-earmark';
                uploadingText = 'Uploading file...';
            }
            
            // Add message text if provided
            let tempMsgContent = '';
            if (messageText) {
                tempMsgContent = `<div class="message-content">${messageText}</div>`;
            }
            
            tempMsg.innerHTML = `
                ${tempMsgContent}
                <div class="image-uploading mt-1">
                    <i class="bi ${uploadingIcon}"></i> ${uploadingText}
                </div>
                <div class="read-status unread">Sending...</div>
            `;
            
            messagesContainer.appendChild(tempMsg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Disable buttons during upload
            const submitBtn = messageForm.querySelector('button[type="submit"]');
            const attachmentButton = document.getElementById('attachment-button');
            
            if (submitBtn) submitBtn.disabled = true;
            if (attachmentButton) attachmentButton.disabled = true;
            
            // Send the request
            fetch('/api/send-message', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Remove temp message
                const tempMsgs = document.querySelectorAll('.temp-message');
                tempMsgs.forEach(el => {
                    if (messagesContainer.contains(el)) {
                        messagesContainer.removeChild(el);
                    }
                });
                
                if (data.success) {
                    console.log('Message with attachment sent successfully:', data.message);
                    
                    // Create properly formatted message based on file type
                    if (data.message.attachment_type && data.message.attachment_type.startsWith('image/')) {
                        createMessageWithImage(data.message, true);
                    } else {
                        createMessageWithDocument(data.message, true);
                    }
                    
                    // Clear inputs
                    if (messageInput) messageInput.value = '';
                    if (fileInput) fileInput.value = '';
                    
                    // Hide preview if shown
                    const previewContainer = document.getElementById('image-preview-container');
                    if (previewContainer) previewContainer.classList.add('d-none');
                } else {
                    console.error('Error sending file:', data.error);
                    alert('Failed to send: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error uploading file:', error);
                alert('Failed to upload file. Please try again.');
                
                // Remove temp message
                const tempMsgs = document.querySelectorAll('.temp-message');
                tempMsgs.forEach(el => {
                    if (messagesContainer.contains(el)) {
                        messagesContainer.removeChild(el);
                    }
                });
            })
            .finally(() => {
                // Re-enable buttons
                if (submitBtn) submitBtn.disabled = false;
                if (attachmentButton) attachmentButton.disabled = false;
            });
        }
        
        // Function to add a message to the chat
        function addMessage(message, isOutgoing, isNew = false) {
            // Determine if message has image or document attachment
            if (message.has_attachment && message.attachment_url) {
                const isImage = message.attachment_type && message.attachment_type.startsWith('image/');
                
                if (isImage) {
                    createMessageWithImage(message, isOutgoing, isNew);
                } else {
                    createMessageWithDocument(message, isOutgoing);
                }
                return;
            }
            
            // Text-only message
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(isOutgoing ? 'message-outgoing' : 'message-incoming');
            
            // Add 'new-message' class if this is a new incoming message
            if (isNew && !isOutgoing) {
                messageElement.classList.add('new-message');
            }
            
            // Create message content element
            if (message.message_text) {
                const contentElement = document.createElement('div');
                contentElement.classList.add('message-content');
                contentElement.textContent = message.message_text;
                messageElement.appendChild(contentElement);
            }
            
            // Add timestamp
            const timeElement = document.createElement('div');
            timeElement.classList.add('message-time');
            const messageTime = new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            timeElement.textContent = messageTime;
            messageElement.appendChild(timeElement);
            
            // Add read status for outgoing messages
            if (isOutgoing) {
                const readStatus = document.createElement('div');
                readStatus.classList.add('read-status');
                readStatus.classList.add(message.is_read ? 'read' : 'unread');
                readStatus.textContent = message.is_read ? 'Read' : 'Delivered';
                messageElement.appendChild(readStatus);
            }
            
            // Add message to container
            messagesContainer.appendChild(messageElement);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Update last message ID
            if (message.id) {
                lastMessageId = message.id;
            }

            // Update conversation in the list
            updateConversationListItem(message);
        }

        // Function to create a message with image attachment
        function createMessageWithImage(message, isOutgoing, isNew = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(isOutgoing ? 'message-outgoing' : 'message-incoming');
            
            // Add 'new-message' class if this is a new incoming message
            if (isNew && !isOutgoing) {
                messageElement.classList.add('new-message');
            }
            
            // Add text content if exists
            if (message.message_text) {
                const contentDiv = document.createElement('div');
                contentDiv.classList.add('message-content');
                contentDiv.textContent = message.message_text;
                messageElement.appendChild(contentDiv);
            }
            
            // Add image attachment
            if (message.has_attachment && message.attachment_url) {
                const attachmentDiv = document.createElement('div');
                attachmentDiv.classList.add('message-attachment');
                
                // Handle Cloudinary URLs
                let imageUrl = message.attachment_url;
                let fullSizeUrl = message.attachment_url;
                
                if (isCloudinaryUrl(message.attachment_url)) {
                    // Optimize for chat display
                    imageUrl = optimizeCloudinaryUrl(message.attachment_url, 'chat');
                    // Optimize for full-size view
                    fullSizeUrl = optimizeCloudinaryUrl(message.attachment_url, 'fullsize');
                }
                
                // Create link for image
                const link = document.createElement('a');
                link.href = fullSizeUrl;
                link.target = '_blank';
                
                // Create image element
                const img = document.createElement('img');
                img.classList.add('message-image', 'loading');
                img.alt = 'Image attachment';
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.display = 'block';
                img.style.borderRadius = '8px';
                img.style.marginTop = '8px';
                
                // Set the image source
                img.src = imageUrl;
                
                // Add loading and error handlers
                img.onload = function() {
                    img.classList.remove('loading');
                };
                
                img.onerror = function() {
                    console.error('Failed to load image:', message.attachment_url);
                    img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWltYWdlLW9mZiI+PHBhdGggZD0iTTIgMmEyIDIgMCAwIDAtMiAydjE2YTIgMiAwIDAgMCAyIDJoMTZhMiAyIDAgMCAwIDItMlY4Ii8+PHBhdGggZD0iTTIgNmg4LjRjMS45MTQgMCAzLjgzLjUyMyA1IDEuNXYtNGEyIDIgMCAwIDAtMi0ySDRhMiAyIDAgMCAwLTIgMnYyeiIvPjxwYXRoIGQ9Ik0yIDE2bDEwLTMuNUwyMiAxNS41Ii8+PHBhdGggZD0iTTE4IDIuNVY1Ii8+PHBhdGggZD0iTTIwLjUgNC4yTDIyIDYiLz48cGF0aCBkPSJNMjIgMmwtOCA4Ii8+PC9zdmc+';
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.alt = 'Image could not be loaded';
                    img.classList.remove('loading');
                };
                
                link.appendChild(img);
                attachmentDiv.appendChild(link);
                messageElement.appendChild(attachmentDiv);
            }
            
            // Add timestamp
            const timeElement = document.createElement('div');
            timeElement.classList.add('message-time');
            const messageTime = new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            timeElement.textContent = messageTime;
            messageElement.appendChild(timeElement);
            
            // Add read status for outgoing messages
            if (isOutgoing) {
                const readStatus = document.createElement('div');
                readStatus.classList.add('read-status');
                readStatus.classList.add(message.is_read ? 'read' : 'unread');
                readStatus.textContent = message.is_read ? 'Read' : 'Delivered';
                messageElement.appendChild(readStatus);
            }
            
            // Add to messages container
            messagesContainer.appendChild(messageElement);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Update last message ID
            if (message.id) {
                lastMessageId = message.id;
            }

            // Update conversation in the list
            updateConversationListItem(message);
        }

        // Function to create a message with document attachment
        function createMessageWithDocument(message, isOutgoing) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(isOutgoing ? 'message-outgoing' : 'message-incoming');
            
            // Add text content if exists
            if (message.message_text) {
                const contentDiv = document.createElement('div');
                contentDiv.classList.add('message-content');
                contentDiv.textContent = message.message_text;
                messageElement.appendChild(contentDiv);
            }
            
            // Add document attachment
            if (message.has_attachment && message.attachment_url) {
                const attachmentDiv = document.createElement('div');
                attachmentDiv.classList.add('message-attachment');
                
                // Create document link with appropriate styling
                const link = document.createElement('a');
                link.href = message.attachment_url;
                link.classList.add('btn', 'btn-sm', 'btn-outline-secondary');
                link.target = '_blank';
                link.style.display = 'inline-flex';
                link.style.alignItems = 'center';
                link.style.gap = '6px';
                link.style.marginTop = '8px';
                
                // Add appropriate icon based on file type
                const icon = document.createElement('i');
                icon.classList.add('bi');
                
                if (message.attachment_type?.includes('pdf')) {
                    icon.classList.add('bi-file-pdf');
                    icon.style.color = '#dc3545';
                } else if (message.attachment_type?.includes('word') || message.attachment_type?.includes('doc')) {
                    icon.classList.add('bi-file-word');
                    icon.style.color = '#0d6efd';
                } else if (message.attachment_type?.includes('excel') || message.attachment_type?.includes('sheet')) {
                    icon.classList.add('bi-file-excel');
                    icon.style.color = '#198754';
                } else {
                    icon.classList.add('bi-file-earmark');
                }
                
                link.appendChild(icon);
                
                // Add file name
                const text = document.createTextNode(message.attachment_name || 'Attachment');
                link.appendChild(text);
                
                attachmentDiv.appendChild(link);
                messageElement.appendChild(attachmentDiv);
            }
            
            // Add timestamp
            const timeElement = document.createElement('div');
            timeElement.classList.add('message-time');
            const messageTime = new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            timeElement.textContent = messageTime;
            messageElement.appendChild(timeElement);
            
            // Add read status for outgoing messages
            if (isOutgoing) {
                const readStatus = document.createElement('div');
                readStatus.classList.add('read-status');
                readStatus.classList.add(message.is_read ? 'read' : 'unread');
                readStatus.textContent = message.is_read ? 'Read' : 'Delivered';
                messageElement.appendChild(readStatus);
            }
            
            // Add to messages container
            messagesContainer.appendChild(messageElement);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Update last message ID
            if (message.id) {
                lastMessageId = message.id;
            }

            // Update conversation in the list
            updateConversationListItem(message);
        }

        // Function to add image message with optimized handling
        function addImageMessage(message, isOutgoing, isNew = false) {
            createMessageWithImage(message, isOutgoing, isNew);
        }

        // Function to add document message
        function addDocumentMessage(message, isOutgoing) {
            createMessageWithDocument(message, isOutgoing);
        }

        // Function to update the conversation list item with the latest message
        function updateConversationListItem(message) {
            const providerId = '<%= activeProvider.id %>';
            const conversationCard = document.querySelector(`.conversation-card[data-provider-id="${providerId}"]`);
            
            if (conversationCard) {
                const lastMessageElement = conversationCard.querySelector('.last-message');
                if (lastMessageElement) {
                    // Update message text or indicate there's an attachment
                    if (message.message_text) {
                        lastMessageElement.textContent = message.message_text;
                    } else if (message.has_attachment) {
                        if (message.attachment_type && message.attachment_type.startsWith('image/')) {
                            lastMessageElement.textContent = 'ðŸ“· Image';
                        } else if (message.attachment_type && message.attachment_type.includes('pdf')) {
                            lastMessageElement.textContent = 'ðŸ“„ PDF Document';
                        } else if (message.attachment_type && (message.attachment_type.includes('word') || message.attachment_type.includes('doc'))) {
                            lastMessageElement.textContent = 'ðŸ“ Document';
                        } else if (message.attachment_type && (message.attachment_type.includes('excel') || message.attachment_type.includes('sheet'))) {
                            lastMessageElement.textContent = 'ðŸ“Š Spreadsheet';
                        } else {
                            lastMessageElement.textContent = 'ðŸ“Ž File attachment';
                        }
                    }
                }

                const timeElement = conversationCard.querySelector('.conversation-time');
                if (timeElement) {
                    const now = new Date();
                    timeElement.innerHTML = `<i class="bi bi-clock"></i> ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                }

                // Move this conversation to the top if it's not already
                const listBody = conversationCard.parentElement;
                if (listBody && listBody.firstChild !== conversationCard) {
                    listBody.insertBefore(conversationCard, listBody.firstChild);
                }
            }
        }
        
        // When the user clicks or interacts with the chat, mark as seen
        chatContainer.addEventListener('click', function() {
            if (!hasSeenNewMessages) {
                hasSeenNewMessages = true;
                chatContainer.classList.remove('has-new-messages');
                document.title = 'My Conversations';
                
                // Mark messages as read via API
                fetch('/api/mark-messages-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversationId: conversationId
                    }),
                }).catch(error => {
                    console.error('Error marking messages as read:', error);
                });
            }
        });
        
        // Scroll to bottom of chat on load
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Cleanup Pusher connection when page unloads
        window.addEventListener('beforeunload', function() {
            pusher.unsubscribe(`conversation-${conversationId}`);
            pusher.unsubscribe(`user-customer-${userId}`);
            pusher.disconnect();
        });
    <% } %>

    // Attachment handling
    const attachmentButton = document.getElementById('attachment-button');
    const fileInput = document.getElementById('image-upload');
    const previewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const removeButton = document.getElementById('remove-image');
    
    if (attachmentButton && fileInput) {
        // Update file input to accept images and documents
        fileInput.setAttribute('accept', 'image/*,.pdf,.doc,.docx,.xls,.xlsx');
        
        // Trigger file selection when clicking the paperclip button
        attachmentButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            fileInput.click();
        });
        
        // Handle file selection
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            console.log('File selected:', file);
            
            // Validate file size
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert('File size must be less than 5MB.');
                fileInput.value = '';
                return;
            }
            
            // Show preview based on file type
            if (imagePreview && previewContainer) {
                if (file.type.startsWith('image/')) {
                    // For images, show actual preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('document-icon');
                        imagePreview.style.width = 'auto';
                        imagePreview.style.maxHeight = '100px';
                        imagePreview.style.maxWidth = '200px';
                    };
                    reader.readAsDataURL(file);
                } else {
                    // For documents, show an appropriate icon
                    imagePreview.classList.add('document-icon');
                    imagePreview.style.width = '64px';
                    imagePreview.style.height = '64px';
                    
                      if (file.type.includes('pdf')) {
                       imagePreview.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNkYzM1NDUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTQuNSAySDZWMjJIMThWNS41TDE0LjUgMloiLz48cGF0aCBkPSJNMTQgMlY2SDE4Ii8+PHBhdGggZD0iTTEyIDEzTDkgMTNNMTIgMTdMOSAxN00xMiA5TDkgOU0xNSAxM0wxOCAxM00xNSA5TDE4IDkiLz48L3N2Zz4=';
                    } else if (file.type.includes('word') || file.type.includes('doc')) {
                        imagePreview.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwZDZlZmQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTQuNSAySDZWMjJIMThWNS41TDE0LjUgMloiLz48cGF0aCBkPSJNMTQgMlY2SDE4Ii8+PHBhdGggZD0iTTE0IDE2SDhNMTQgMTJIOE0xNCA4SDgiLz48L3N2Zz4=';
                    } else if (file.type.includes('excel') || file.type.includes('sheet')) {
                        imagePreview.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMxOTg3NTQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTQuNSAySDZWMjJIMThWNS41TDE0LjUgMloiLz48cGF0aCBkPSJNMTQgMlY2SDE4Ii8+PHBhdGggZD0iTTggMTBIMTFNMTQgMTBIMTYiLz48cGF0aCBkPSJNOCAxNEgxMU0xNCAxNEgxNiIvPjxwYXRoIGQ9Ik04IDE4SDExTTE0IDE4SDE2Ii8+PC9zdmc+';
                    } else {
                        imagePreview.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM2YzczNzYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTQuNSAySDZWMjJIMThWNS41TDE0LjUgMloiLz48cGF0aCBkPSJNMTQgMlY2SDE4Ii8+PC9zdmc+';
                    }
                }
                
                // Show the preview container
                previewContainer.classList.remove('d-none');
            }
        });
    }
    
    // Remove button for attachments
    if (removeButton) {
        removeButton.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (fileInput) fileInput.value = '';
            if (previewContainer) previewContainer.classList.add('d-none');
        };
    }

    // Check for unread messages count
    function checkUnreadCount() {
        fetch('/api/unread-count')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const unreadBadge = document.getElementById('unread-badge');
                    if (unreadBadge && data.unreadCount > 0) {
                        unreadBadge.textContent = data.unreadCount;
                        unreadBadge.style.display = 'inline-block';
                    } else if (unreadBadge) {
                        unreadBadge.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error checking unread count:', error);
            });
    }
    
    // Check unread count every 30 seconds
    setInterval(checkUnreadCount, 30000);
    
    // Check unread count on page load
    checkUnreadCount();

    // Add CSS for Cloudinary image loading states
    const cloudinaryStyles = document.createElement('style');
    cloudinaryStyles.textContent = `
        .message-image.loading {
            min-height: 80px;
            background-color: rgba(0,0,0,0.05);
            position: relative;
        }
        
        .message-image.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid rgba(0, 119, 190, 0.2);
            border-top-color: rgba(0, 119, 190, 0.8);
            transform: translate(-50%, -50%);
            animation: cloudinary-loading 1s infinite linear;
        }
        
        @keyframes cloudinary-loading {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }
        
        .document-icon {
            width: 64px !important;
            height: 64px !important;
            object-fit: contain;
            background-color: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .message-attachment .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: white;
            color: #333;
            padding: 6px 12px;
            border-radius: 6px;
            margin-top: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        
        .message-attachment .btn:hover {
            background-color: #f8f9fa;
        }
        
        .message-outgoing .message-attachment .btn {
            background-color: rgba(255,255,255,0.2);
            color: white;
        }
        
        .message-outgoing .message-attachment .btn:hover {
            background-color: rgba(255,255,255,0.3);
        }
        
        .image-uploading {
            font-size: 0.85rem;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 6px;
        }
    `;
    document.head.appendChild(cloudinaryStyles);
});
</script>

</body> 
</html>