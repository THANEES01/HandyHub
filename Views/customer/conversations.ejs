<!DOCTYPE html> 
<html lang="en"> <head> 
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title><%= title %></title> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"> 
    <link rel="stylesheet" href="/css/style.css"> 
    <style> 
    :root { 
        --primary-blue: #0077be; 
        --secondary-blue: #00a2e8; 
        --dark-blue: #003366; 
        --light-blue: #e6f2ff; 
    }

    .conversation-card {
        border-radius: 10px;
        border: 1px solid #eee;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
    }
  
    .conversation-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .conversation-link {
        display: block;
        color: inherit;
        text-decoration: none;
    }
    
    .conversation-card .card-body {
        padding: 15px;
    }
    
    .provider-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .provider-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: var(--light-blue);
        color: var(--dark-blue);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .provider-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--dark-blue);
        margin-bottom: 5px;
    }
    
    .last-message {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 5px;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .conversation-time {
        font-size: 0.8rem;
        color: #888;
    }
    
    .unread-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background-color: var(--primary-blue);
        color: white;
        font-size: 0.8rem;
        border-radius: 50%;
        min-width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
    }
</style>

</head> 

<body> <!-- Navbar --> <%- include('../partials/navbar') %>

<div class="container mt-5 mb-5">
    <div class="d-flex align-items-center justify-content-between mb-4">
       <a href="/customer/dashboard" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
        <h1>My Conversations</h1>
        <div style="width: 145px;"><!-- Empty div to balance the flexbox layout --></div>
    </div>

    <% if (locals.error) { %>
        <div class="alert alert-danger" role="alert">
            <%= error %>
        </div>
    <% } %>
    
    <% if (locals.success) { %>
        <div class="alert alert-success" role="alert">
            <%= success %>
        </div>
    <% } %>
    
    <div class="row">
        <div class="col-lg-8">
            <% if (conversations && conversations.length > 0) { %>
                <% conversations.forEach(conv => { %>
                    <div class="conversation-card">
                        <a href="/customer/chat/<%= conv.provider_id %>" class="conversation-link">
                            <div class="card-body">
                                <div class="provider-info">
                                    <div class="provider-avatar">
                                        <%= conv.provider_name.charAt(0).toUpperCase() %>
                                    </div>
                                    <div>
                                        <div class="provider-name">
                                            <%= conv.provider_name %>
                                        </div>
                                        <div class="last-message">
                                            <%= conv.last_message || 'No messages yet' %>
                                        </div>
                                        <div class="conversation-time">
                                            <% if (conv.last_message_time) { %>
                                                <% 
                                                    const msgDate = new Date(conv.last_message_time);
                                                    const today = new Date();
                                                    const yesterday = new Date(today);
                                                    yesterday.setDate(yesterday.getDate() - 1);
                                                    
                                                    if (msgDate.toDateString() === today.toDateString()) {
                                                        // Show time only if today
                                                        %><%= msgDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %><%
                                                    } else if (msgDate.toDateString() === yesterday.toDateString()) {
                                                        // Show "Yesterday" if yesterday
                                                        %>Yesterday<%
                                                    } else {
                                                        // Show date otherwise
                                                        %><%= msgDate.toLocaleDateString() %><%
                                                    }
                                                %>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                                <% if (parseInt(conv.unread_count) > 0) { %>
                                    <div class="unread-badge">
                                        <%= conv.unread_count %>
                                    </div>
                                <% } %>
                            </div>
                        </a>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="text-center py-5 bg-light rounded mb-4">
                    <i class="bi bi-chat-dots" style="font-size: 3rem; color: #ccc;"></i>
                    <h3 class="mt-3">No conversations yet</h3>
                    <p class="text-muted">Start a conversation with a service provider by visiting their profile.</p>
                    <a href="/customer/categories" class="btn btn-primary mt-2">
                        <i class="bi bi-search"></i> Find Service Providers
                    </a>
                </div>
            <% } %>
        </div>
 
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-info-circle"></i> About Messages</h5>
                    <p class="card-text">
                        You can communicate directly with service providers through our messaging system.
                        This is useful for discussing service details, scheduling, or asking questions before booking.
                    </p>
                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success"></i> Real-time messaging
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success"></i> Get quick responses
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success"></i> Discuss service details
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success"></i> Clear communication
                        </li>
                    </ul>
                    <a href="/customer/categories" class="btn btn-primary">
                        <i class="bi bi-search"></i> Find Providers
                    </a>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-shield-check"></i> Safety Tips</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                            Keep all communication through our platform
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                            Don't share personal financial information
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                            Report any suspicious behavior
                        </li>
                        <li>
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                            Complete all bookings through our system
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="contact">
    <!-- Footer  -->
    <%- include('../partials/footer') %>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Connect to Socket.IO for real-time notifications
        const socket = io({
            auth: {
                userType: 'customer'
            }
        });
        
        // Listen for new messages
        socket.on('new-message', function(data) {
            // Refresh the page to show the latest conversations
            if (data.to_user_type === 'customer') {
                window.location.reload();
            }
        });
        
        // Function to poll for unread count
        function checkUnreadMessages() {
            fetch('/api/unread-count')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.unreadCount > 0) {
                        // Update title to show unread count
                        document.title = `(${data.unreadCount}) My Conversations`;
                    }
                })
                .catch(error => {
                    console.error('Error checking unread messages:', error);
                });
        }
        
        // Check for unread messages every 30 seconds
        setInterval(checkUnreadMessages, 30000);
        
        // Initial check
        checkUnreadMessages();
    });
</script>
</body> </html>
