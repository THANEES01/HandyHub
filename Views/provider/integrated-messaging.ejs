<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #0077be;
            --secondary-blue: #00a2e8;
            --dark-blue: #003366;
            --light-blue: #e6f2ff;
            --sidebar-width: 250px;
        }

        body {
            min-height: 100vh;
            background-color: #f8f9fa;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--dark-blue);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding-top: 20px;
            z-index: 1030;
        }
        
        .sidebar-brand {
            color: white;
            font-size: 1.5rem;
            padding: 20px;
            text-decoration: none;
            display: block;
            margin-bottom: 20px;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            margin: 4px 0;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover, .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .nav-link i {
            margin-right: 10px;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .conversations-container {
            display: flex;
            flex: 1;
            gap: 20px;
            height: calc(100vh - 140px);
            min-height: 400px;
            overflow: hidden;
        }
        
        .conversation-list {
            width: 350px;
            min-width: 300px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }
        
        .list-header {
            padding: 15px;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--primary-blue);
            color: white;
        }
        
        .list-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            max-height: calc(100% - 50px);
        }
        
        .conversation-card {
            padding: 15px;
            border-bottom: 1px solid #f5f5f5;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }
        
        .conversation-card:hover {
            background-color: var(--light-blue);
            transform: translateX(5px);
        }
        
        .conversation-card.active {
            background-color: var(--light-blue);
            border-left: 4px solid var(--primary-blue);
            padding-left: 11px;
        }
        
        .customer-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .customer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--light-blue);
            color: var(--dark-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .conversation-details {
            flex: 1;
            min-width: 0;
        }
        
        .customer-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--dark-blue);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .last-message {
            color: #666;
            font-size: 0.85rem;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: #999;
            white-space: nowrap;
        }
        
        .unread-badge {
            background-color: var(--primary-blue);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            position: absolute;
            top: 15px;
            right: 15px;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow: hidden;
            height: 100%;
        }
        
        .empty-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            color: #999;
            padding: 20px;
        }
        
        .empty-chat i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #ccc;
            opacity: 0.7;
        }

        .empty-chat h3 {
            color: #555;
            margin-bottom: 10px;
        }
        
        .chat-header {
            background-color: var(--primary-blue);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .chat-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #f9f9f9;
            max-height: calc(100% - 135px);
        }
        
        .message {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 18px;
            position: relative;
            word-break: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            animation: messageAppear 0.3s ease-out;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: #000000;
            margin-top: 5px;
            text-align: right;
        }
        
        .message-outgoing {
            align-self: flex-end;
            background-color: var(--primary-blue);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message-incoming {
            align-self: flex-start;
            background-color: #e6e6e6;
            color: #333;
            border-bottom-left-radius: 5px;
        }
        
        .message-attachment {
            margin-top: 8px;
        }
        
        .message-image {
            max-width: 300px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 5px;
            border: 1px solid rgba(0,0,0,0.1);
            background-color: rgba(0,0,0,0.05);
        }

        .message-outgoing .message-image {
            border-color: rgba(255,255,255,0.3);
        }

        .message-attachment .btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }
        
        .chat-input {
            padding: 15px;
            border-top: 1px solid #eee;
            background-color: white;
            width: 100%;
        }
        
        .chat-input .input-group {
            display: flex;
            width: 100%;
            gap: 10px;
            align-items: center;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 30px;
            outline: none;
            min-width: 0;
            width: 100%;
        }

        .chat-input button[type="submit"] {
            min-width: 100px;
            white-space: nowrap;
            padding: 10px 20px;
        }
        
        .chat-input input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 119, 190, 0.1);
        }
        
        .chat-input button {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chat-input button:hover {
            background-color: var(--dark-blue);
        }

        .chat-input .attachment-btn {
            background-color: #6c757d;
            padding: 10px 15px;
            border-radius: 50%;
            height: 40px;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            border: none;
            color: white;
        }

        .chat-input .attachment-btn:hover {
            background-color: #5a6268;
            transform: scale(1.05);
        }
        
        .read-status {
            font-size: 0.7rem;
            margin-top: 2px;
            text-align: right;
        }
        
        .read-status.read {
            color: #000000;
        }
        
        .read-status.unread {
            color: #adb5bd;
        }
        
        .typing-indicator {
            display: none;
            align-self: flex-start;
            background-color: #e6e6e6;
            color: #333;
            border-radius: 15px;
            padding: 8px 15px;
            font-size: 0.9rem;
            margin-bottom: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #666;
            border-radius: 50%;
            animation: typing 1s infinite;
            margin: 0 1px;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        .chat-container {
            display: none;
        }
        
        .chat-container.active {
            display: flex;
        }
        
        .empty-chat.hidden {
            display: none;
        }

        #image-preview-container {
            background-color: rgba(0,0,0,0.03);
            border-radius: 12px;
            padding: 10px;
            margin-top: 10px;
            max-width: 220px;
        }

        #image-preview {
            max-height: 100px;
            max-width: 200px;
            border-radius: 8px;
        }

        .document-icon {
             width: 64px !important;
            height: 64px !important;
            object-fit: contain;
            background-color: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .message-image.loading {
            min-height: 80px;
            background-color: rgba(0,0,0,0.05);
            position: relative;
        }
        
        .message-image.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid rgba(0, 119, 190, 0.2);
            border-top-color: rgba(0, 119, 190, 0.8);
            transform: translate(-50%, -50%);
            animation: cloudinary-loading 1s infinite linear;
        }
        
        @keyframes cloudinary-loading {
             to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .image-uploading {
            font-size: 0.85rem;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        @keyframes typing {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        
        @media (max-width: 992px) {
            .conversations-container {
                flex-direction: column;
                height: auto;
                max-height: calc(100vh - 140px);
            }
            
            .conversation-list {
                width: 100%;
                height: 300px;
                min-height: 200px;
            }
            
            .chat-container, .empty-chat {
                flex: 1;
                min-height: 400px;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
                margin-left: 0;
                padding-left: calc(var(--sidebar-width) + 15px);
            }
        
            .chat-messages {
                padding: 10px;
            }
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn-pulse {
            animation: pulse 1.5s infinite;
        }

        .btn-clicked {
            transform: scale(0.95);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 119, 190, 0.4);
            }
            70% {
                box-shadow: 0 0 0 8px rgba(0, 119, 190, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 119, 190, 0);
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <a href="/provider/dashboard" class="sidebar-brand">
            <i class="bi bi-tools"></i> HandyHub Provider
        </a>
        <nav class="nav flex-column">
            <a class="nav-link <%= currentPage === 'dashboard' ? 'active' : '' %>" href="/provider/dashboard">
                <i class="bi bi-person"></i> Profile
            </a>
            <a class="nav-link <%= currentPage === 'bookings' ? 'active' : '' %>" href="/provider/bookings">
                <i class="bi bi-calendar-check"></i> Bookings
            </a>
            <a class="nav-link <%= currentPage === 'conversations' ? 'active' : '' %>" href="/provider/conversations">
                <i class="bi bi-chat-dots"></i> Messages
                <span id="unread-badge" class="badge bg-danger rounded-pill" style="display: none;"></span>
            </a>
            <a class="nav-link <%= currentPage === 'reviews' ? 'active' : '' %>" href="/provider/reviews">
                <i class="bi bi-star"></i> Reviews & Ratings
            </a>
            <a class="nav-link <%= currentPage === 'earnings' ? 'active' : '' %>" href="/provider/earnings">
                <i class="bi bi-wallet2"></i> Earnings
            </a>
            <a class="nav-link text-danger" href="/auth/logout">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Messages</h1>
            <a href="/provider/dashboard" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
        
        <div class="conversations-container">
            <div class="conversation-list">
                <div class="list-header">
                    <h5 class="mb-0">Conversations</h5>
                    <span class="badge bg-light text-dark rounded-pill">
                        <% 
                            let totalUnread = 0;
                            conversations.forEach(conv => {
                                totalUnread += parseInt(conv.unread_count || 0);
                            });
                        %>
                        <%= totalUnread %> Unread
                    </span>
                </div>
                <div class="list-body">
                    <% if (conversations && conversations.length > 0) { %>
                        <% conversations.forEach(conv => { %>
                            <div class="conversation-card <%= activeConversation && activeConversation.id == conv.conversation_id ? 'active' : '' %>" 
                                 data-conversation-id="<%= conv.conversation_id %>"
                                 onclick="window.location.href='/provider/conversations?conversation=<%= conv.conversation_id %>'">
                                <% if (parseInt(conv.unread_count) > 0) { %>
                                    <div class="unread-badge">
                                        <%= conv.unread_count %>
                                    </div>
                                <% } %>
                                
                                <div class="customer-info">
                                    <div class="customer-avatar">
                                        <%= conv.customer_name.charAt(0).toUpperCase() %>
                                    </div>
                                    <div class="conversation-details">
                                        <div class="customer-name">
                                            <%= conv.customer_name %>
                                        </div>
                                        <div class="last-message">
                                            <% if (conv.last_message_has_attachment && (!conv.last_message || conv.last_message.trim() === '')) { %>
                                                <% if (conv.last_message_attachment_type && conv.last_message_attachment_type.startsWith('image/')) { %>
                                                    📷 Image
                                                <% } else if (conv.last_message_attachment_type && conv.last_message_attachment_type.includes('pdf')) { %>
                                                    📄 PDF Document
                                                <% } else if (conv.last_message_attachment_type && (conv.last_message_attachment_type.includes('word') || conv.last_message_attachment_type.includes('doc'))) { %>
                                                    📝 Document
                                                <% } else if (conv.last_message_attachment_type && (conv.last_message_attachment_type.includes('excel') || conv.last_message_attachment_type.includes('sheet'))) { %>
                                                    📊 Spreadsheet
                                                <% } else { %>
                                                    📎 File attachment
                                                <% } %>
                                            <% } else { %>
                                                <%= conv.last_message || 'No messages yet' %>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="message-time mt-2 text-end">
                                    <% if (conv.last_message_time) { %>
                                        <% 
                                            const msgDate = new Date(conv.last_message_time);
                                            const today = new Date();
                                            const yesterday = new Date(today);
                                            yesterday.setDate(yesterday.getDate() - 1);
                                            
                                            if (msgDate.toDateString() === today.toDateString()) {
                                                %><i class="bi bi-clock"></i> <%= msgDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %><%
                                            } else if (msgDate.toDateString() === yesterday.toDateString()) {
                                                %><i class="bi bi-calendar-check"></i> Yesterday<%
                                            } else {
                                                %><i class="bi bi-calendar"></i> <%= msgDate.toLocaleDateString() %><%
                                            }
                                        %>
                                    <% } %>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="text-center py-5">
                            <i class="bi bi-chat-dots" style="font-size: 3rem; color: #ccc;"></i>
                            <h3 class="mt-3">No messages yet</h3>
                            <p class="text-muted">When customers message you, they will appear here.</p>
                        </div>
                    <% } %>
                </div>
            </div>
            
            <div class="empty-chat <%= activeConversation ? 'hidden' : '' %>" id="empty-chat">
                <i class="bi bi-chat-square-text"></i>
                <h3>Select a conversation</h3>
                <p class="text-center">Choose a conversation from the list to start chatting</p>
            </div>
            
            <div class="chat-container <%= activeConversation ? 'active' : '' %>" id="chat-container">
                <% if (activeConversation) { %>
                    <div class="chat-header">
                        <div class="customer-info">
                            <div class="customer-avatar">
                                <%= activeConversation.customer_name.charAt(0).toUpperCase() %>
                            </div>
                            <h2><%= activeConversation.customer_name %></h2>
                        </div>
                        <div>
                            <a href="/provider/bookings" class="btn btn-sm btn-light">
                                <i class="bi bi-clipboard-check"></i> View Bookings
                            </a>
                        </div>
                    </div>
                    
                    <div class="chat-messages" id="chat-messages">
                        <% if (messages && messages.length > 0) { %>
                            <% messages.forEach(message => { %>
                                <div class="message <%= message.sender_type === 'provider' ? 'message-outgoing' : 'message-incoming' %>">
                                    <% if (message.message_text) { %>
                                        <div class="message-content"><%= message.message_text %></div>
                                    <% } %>
                                    
                                    <% if (message.has_attachment && message.attachment_url) { %>
                                        <% const isImage = message.attachment_type && message.attachment_type.startsWith('image/'); %>
                                        <% if (isImage) { %>
                                            <div class="message-attachment">
                                                <a href="<%= message.attachment_url %>" target="_blank">
                                                    <img src="<%= message.attachment_url %>" class="message-image" alt="Image attachment">
                                                </a>
                                            </div>
                                        <% } else { %>
                                            <div class="message-attachment">
                                                <a href="<%= message.attachment_url %>" class="btn btn-sm btn-outline-secondary" target="_blank">
                                                    <i class="bi bi-paperclip"></i> <%= message.attachment_name || 'Attachment' %>
                                                </a>
                                            </div>
                                        <% } %>
                                    <% } %>
                                    
                                    <div class="message-time">
                                        <%= new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
                                    </div>
                                    
                                    <% if (message.sender_type === 'provider') { %>
                                        <div class="read-status <%= message.is_read ? 'read' : 'unread' %>">
                                            <%= message.is_read ? 'Read' : 'Delivered' %>
                                        </div>
                                    <% } %>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="text-center text-muted my-4">
                                <p>No messages yet. Start the conversation!</p>
                            </div>
                        <% } %>
                        <div class="typing-indicator" id="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                    
                   <div class="chat-input">
                        <form id="message-form" data-conversation-id="<%= activeConversation.id %>">
                            <!-- Hidden file input -->
                            <input type="file" id="image-upload" name="attachment" style="display: none;" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx">
                            
                            <div class="input-group w-100"> 
                                <!-- Paperclip attachment button -->
                                <button type="button" class="btn attachment-btn" id="attachment-button" title="Attach file">
                                    <i class="bi bi-paperclip"></i>
                                </button>
                                
                                <!-- Message input -->
                                <input type="text" id="message-input" class="form-control flex-grow-1" placeholder="Type your message..." autocomplete="off">
                                
                                <!-- Send button -->
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-send"></i> Send
                                </button>
                            </div>
                            
                            <!-- Image preview container -->
                            <div id="image-preview-container" class="d-none mt-2">
                                <div class="position-relative d-inline-block">
                                    <img id="image-preview" class="rounded border" style="max-height: 100px; max-width: 200px; object-fit: contain;">
                                    <button type="button" id="remove-image" class="btn btn-sm btn-danger position-absolute" style="top: -10px; right: -10px; border-radius: 50%; width: 24px; height: 24px; padding: 0;">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Replace Socket.IO with Pusher -->
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            <% if (activeConversation) { %>
                const messageForm = document.getElementById('message-form');
                const messageInput = document.getElementById('message-input');
                const messagesContainer = document.getElementById('chat-messages');
                const typingIndicator = document.getElementById('typing-indicator');
                const conversationId = '<%= activeConversation.id %>';
                let lastMessageId = '<%= messages && messages.length > 0 ? messages[messages.length - 1].id : 0 %>';
                let typingTimeout;
                
                const fileInput = document.getElementById('image-upload');
                const attachmentButton = document.getElementById('attachment-button');
                const imagePreviewContainer = document.getElementById('image-preview-container');
                const imagePreview = document.getElementById('image-preview');
                const removeImageButton = document.getElementById('remove-image');
                
                // **PUSHER CONFIGURATION**
                const pusher = new Pusher('<%= pusherKey %>', {
                    cluster: '<%= pusherCluster %>',
                    encrypted: true,
                    authEndpoint: '/pusher/auth',
                    auth: {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    }
                });

                // Subscribe to conversation channel
                const conversationChannel = pusher.subscribe(`conversation-${conversationId}`);
                
                // Subscribe to provider notification channel  
                const providerId = '<%= user.providerId %>';
                const userChannel = pusher.subscribe(`user-provider-${providerId}`);
                
                function isCloudinaryUrl(url) {
                    return url && (url.includes('cloudinary.com') || url.includes('res.cloudinary.com'));
                }

                function optimizeCloudinaryUrl(url, type) {
                    if (!isCloudinaryUrl(url)) return url;
                    
                    if (url.includes('/upload/')) {
                        const parts = url.split('/upload/');
                        
                        switch(type) {
                            case 'thumbnail':
                                return `${parts[0]}/upload/c_fill,w_100,h_100,g_auto/${parts[1]}`;
                            case 'preview':
                                return `${parts[0]}/upload/c_scale,w_300/${parts[1]}`;
                            case 'chat':
                                return `${parts[0]}/upload/c_limit,w_500,h_400/${parts[1]}`;
                            case 'fullsize':
                                return `${parts[0]}/upload/q_auto,f_auto/${parts[1]}`;
                            default:
                                return url;
                        }
                    }
                    
                    return url;
                }
                
                // **PUSHER EVENT HANDLERS**
                
                // Handle incoming messages
                conversationChannel.bind('new-message', function(data) {
                    console.log('Pusher: received message', data);
                    if (data.sender_type === 'customer') {
                        if (data.has_attachment) {
                            if (data.attachment_type && data.attachment_type.startsWith('image/')) {
                                addImageMessage(data, false);
                            } else {
                                addDocumentMessage(data, false);
                            }
                        } else {
                            addMessage(data, false);
                        }
                        
                        // Mark message as read via API
                        fetch('/api/mark-messages-read', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                conversationId: conversationId
                            }),
                        }).catch(error => {
                            console.error('Error marking messages as read:', error);
                        });
                    }
                });

                // Handle read receipts
                conversationChannel.bind('messages-read', function(data) {
                    console.log('Pusher: messages read', data);
                    if (data.readBy === 'customer') {
                        // Update read status for all outgoing messages
                        const messages = document.querySelectorAll('.message.message-outgoing');
                        messages.forEach(message => {
                            const readStatus = message.querySelector('.read-status');
                            if (readStatus) {
                                readStatus.textContent = 'Read';
                                readStatus.classList.remove('unread');
                                readStatus.classList.add('read');
                            }
                        });
                    }
                });

                // Handle message notifications (for other conversations)
                userChannel.bind('message-notification', function(data) {
                    console.log('Pusher: message notification', data);
                    // Update unread count badge
                    checkUnreadCount();
                });
                
                // File upload button handler
                if (attachmentButton) {
                    attachmentButton.addEventListener('click', function() {
                        fileInput.click();
                    });
                }
                
                // File input change handler
                if (fileInput) {
                    fileInput.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        if (file.size > 5 * 1024 * 1024) {
                            alert('File size must be less than 5MB');
                            fileInput.value = '';
                            return;
                        }
                        
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                imagePreview.src = e.target.result;
                                imagePreview.classList.remove('document-icon');
                                imagePreview.style.width = 'auto';
                                imagePreview.style.maxHeight = '100px';
                                imagePreview.style.maxWidth = '200px';
                                imagePreviewContainer.classList.remove('d-none');
                            };
                            reader.readAsDataURL(file);
                        } else {
                            imagePreview.classList.add('document-icon');
                            imagePreview.style.width = '64px';
                            imagePreview.style.height = '64px';
                            
                            if (file.type.includes('pdf')) {
                                imagePreview.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNkYzM1NDUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTQuNSAySDZWMjJIMThWNS41TDE0LjUgMloiLz48cGF0aCBkPSJNMTQgMlY2SDE4Ii8+PHBhdGggZD0iTTEyIDEzTDkgMTNNMTIgMTdMOSAxN00xMiA5TDkgOU0xNSAxM0wxOCAxM00xNSA5TDE4IDkiLz48L3N2Zz4=';
                            } else if (file.type.includes('word') || file.type.includes('doc')) {
                                imagePreview.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwZDZlZmQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTQuNSAySDZWMjJIMThWNS41TDE0LjUgMloiLz48cGF0aCBkPSJNMTQgMlY2SDE4Ii8+PHBhdGggZD0iTTE0IDE2SDhNMTQgMTJIOE0xNCA4SDgiLz48L3N2Zz4=';
                            } else if (file.type.includes('excel') || file.type.includes('sheet')) {
                                imagePreview.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMxOTg3NTQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTQuNSAySDZWMjJIMThWNS41TDE0LjUgMloiLz48cGF0aCBkPSJNMTQgMlY2SDE4Ii8+PHBhdGggZD0iTTggMTBIMTFNMTQgMTBIMTYiLz48cGF0aCBkPSJNOCAxNEgxMU0xNCAxNEgxNiIvPjxwYXRoIGQ9Ik04IDE4SDExTTE0IDE4SDE2Ii8+PC9zdmc+';
                            } else {
                                imagePreview.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM2YzczNzYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTQuNSAySDZWMjJIMThWNS41TDE0LjUgMloiLz48cGF0aCBkPSJNMTQgMlY2SDE4Ii8+PC9zdmc+';
                            }
                            
                            imagePreviewContainer.classList.remove('d-none');
                        }
                    });
                }
                
                // Remove image button handler
                if (removeImageButton) {
                    removeImageButton.addEventListener('click', function() {
                        fileInput.value = '';
                        imagePreviewContainer.classList.add('d-none');
                    });
                }
                
                // Submit message form - UNIFIED HANDLING (same as customer)
                messageForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const message = messageInput.value.trim();
                    const file = fileInput.files[0];
                    
                    if (file) {
                        // Handle file upload with message
                        uploadFileWithMessage(file, message);
                        return;
                    }
                    
                    if (!message) return;
                    
                    // Handle text-only message
                    console.log('Sending text message:', message, 'to conversation:', conversationId);
                    
                    fetch('/api/send-message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            conversationId: conversationId,
                            message: message,
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('API response:', data);
                        if (data.success) {
                            addMessage(data.message, true);
                            messageInput.value = '';
                        } else {
                            console.error('Error sending message:', data.error);
                            alert('Failed to send message: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        alert('Failed to send message. Please try again.');
                    });
                });
                
                // Function to upload file with message
                function uploadFileWithMessage(file, messageText) {
                    if (!file) return;
                    
                    // Validate file size
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size must be less than 5MB.');
                        return;
                    }
                    
                    // Create FormData
                    const formData = new FormData();
                    formData.append('conversationId', conversationId);
                    formData.append('message', messageText || '');
                    formData.append('attachment', file);
                    
                    // Create temporary message with loading indicator
                    const tempMsg = document.createElement('div');
                    tempMsg.classList.add('message', 'message-outgoing', 'temp-message');
                    
                    let uploadingIcon, uploadingText;
                    if (file.type.startsWith('image/')) {
                        uploadingIcon = 'bi-image';
                        uploadingText = 'Uploading image...';
                    } else if (file.type.includes('pdf')) {
                        uploadingIcon = 'bi-file-pdf';
                        uploadingText = 'Uploading PDF...';
                    } else if (file.type.includes('word') || file.type.includes('doc')) {
                        uploadingIcon = 'bi-file-word';
                        uploadingText = 'Uploading document...';
                    } else if (file.type.includes('excel') || file.type.includes('sheet')) {
                        uploadingIcon = 'bi-file-excel';
                        uploadingText = 'Uploading spreadsheet...';
                    } else {
                        uploadingIcon = 'bi-file-earmark';
                        uploadingText = 'Uploading file...';
                    }
                    
                    let tempMsgContent = '';
                    if (messageText) {
                        tempMsgContent = `<div class="message-content">${messageText}</div>`;
                    }
                    
                    tempMsg.innerHTML = `
                        ${tempMsgContent}
                        <div class="image-uploading mt-1">
                            <i class="bi ${uploadingIcon}"></i> ${uploadingText}
                        </div>
                        <div class="read-status unread">Sending...</div>
                    `;
                    
                    messagesContainer.appendChild(tempMsg);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // Send the request using the unified endpoint
                    fetch('/api/send-message', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        document.querySelectorAll('.temp-message').forEach(el => {
                            messagesContainer.removeChild(el);
                        });
                        
                        if (data.success) {
                            if (data.message.attachment_type && data.message.attachment_type.startsWith('image/')) {
                                addImageMessage(data.message, true);
                            } else {
                                addDocumentMessage(data.message, true);
                            }
                            
                            messageInput.value = '';
                            fileInput.value = '';
                            imagePreviewContainer.classList.add('d-none');
                        } else {
                            console.error('Error uploading file:', data.error);
                            alert('Failed to upload file: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        document.querySelectorAll('.temp-message').forEach(el => {
                            messagesContainer.removeChild(el);
                        });
                        
                        console.error('Error uploading file:', error);
                        alert('Failed to upload file. Please try again.');
                    });
                }
                
                // Function to add a message to the chat
                function addMessage(message, isOutgoing) {
                    if (message.has_attachment && message.attachment_url) {
                        const isImage = message.attachment_type && message.attachment_type.startsWith('image/');
                        if (isImage) {
                            return addImageMessage(message, isOutgoing);
                        } else {
                            return addDocumentMessage(message, isOutgoing);
                        }
                    }
                    
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message');
                    messageElement.classList.add(isOutgoing ? 'message-outgoing' : 'message-incoming');
                    
                    const contentElement = document.createElement('div');
                    contentElement.classList.add('message-content');
                    contentElement.textContent = message.message_text;
                    messageElement.appendChild(contentElement);
                    
                    const timeElement = document.createElement('div');
                    timeElement.classList.add('message-time');
                    const messageTime = new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    timeElement.textContent = messageTime;
                    messageElement.appendChild(timeElement);
                    
                    if (isOutgoing) {
                        const readStatus = document.createElement('div');
                        readStatus.classList.add('read-status');
                        readStatus.classList.add(message.is_read ? 'read' : 'unread');
                        readStatus.textContent = message.is_read ? 'Read' : 'Delivered';
                        messageElement.appendChild(readStatus);
                    }
                    
                    messagesContainer.appendChild(messageElement);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    lastMessageId = message.id;
                    updateConversationListItem(message);
                }
                
                // Function to add an image message
                function addImageMessage(message, isOutgoing) {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message');
                    messageElement.classList.add(isOutgoing ? 'message-outgoing' : 'message-incoming');
                    
                    if (message.message_text) {
                        const contentDiv = document.createElement('div');
                        contentDiv.classList.add('message-content');
                        contentDiv.textContent = message.message_text;
                        messageElement.appendChild(contentDiv);
                    }
                    
                    if (message.has_attachment && message.attachment_url) {
                        const attachmentDiv = document.createElement('div');
                        attachmentDiv.classList.add('message-attachment');
                        
                        let imageUrl = message.attachment_url;
                        let fullSizeUrl = message.attachment_url;
                        
                        if (isCloudinaryUrl(message.attachment_url)) {
                            imageUrl = optimizeCloudinaryUrl(message.attachment_url, 'chat');
                            fullSizeUrl = optimizeCloudinaryUrl(message.attachment_url, 'fullsize');
                        }
                        
                        const link = document.createElement('a');
                        link.href = fullSizeUrl;
                        link.target = "_blank";
                        
                        const img = document.createElement('img');
                        img.classList.add('message-image', 'loading');
                        img.alt = 'Image attachment';
                        
                        img.src = imageUrl;
                        
                        img.onload = function() {
                            img.classList.remove('loading');
                        };
                        
                        img.onerror = function() {
                            console.error('Failed to load image:', message.attachment_url);
                            img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWltYWdlLW9mZiI+PHBhdGggZD0iTTIgMmEyIDIgMCAwIDAtMiAydjE2YTIgMiAwIDAgMCAyIDJoMTZhMiAyIDAgMCAwIDItMlY4Ii8+PHBhdGggZD0iTTIgNmg4LjRjMS45MTQgMCAzLjgzLjUyMyA1IDEuNXYtNGEyIDIgMCAwIDAtMi0ySDRhMiAyIDAgMCAwLTIgMnYyeiIvPjxwYXRoIGQ9Ik0yIDE2bDEwLTMuNUwyMiAxNS41Ii8+PHBhdGggZD0iTTE4IDIuNVY1Ii8+PHBhdGggZD0iTTIwLjUgNC4yTDIyIDYiLz48cGF0aCBkPSJNMjIgMmwtOCA4Ii8+PC9zdmc+';
                            img.style.width = '100px';
                            img.style.height = '100px';
                            img.alt = 'Image could not be loaded';
                            img.classList.remove('loading');
                        };
                        
                        link.appendChild(img);
                        attachmentDiv.appendChild(link);
                        messageElement.appendChild(attachmentDiv);
                    }
                    
                    const timeElement = document.createElement('div');
                    timeElement.classList.add('message-time');
                    const messageTime = new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    timeElement.textContent = messageTime;
                    messageElement.appendChild(timeElement);
                    
                    if (isOutgoing) {
                        const readStatus = document.createElement('div');
                        readStatus.classList.add('read-status');
                        readStatus.classList.add(message.is_read ? 'read' : 'unread');
                        readStatus.textContent = message.is_read ? 'Read' : 'Delivered';
                        messageElement.appendChild(readStatus);
                    }
                    
                    messagesContainer.appendChild(messageElement);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    lastMessageId = message.id;
                    updateConversationListItem(message);
                }
                
                // Function to add a document message
                function addDocumentMessage(message, isOutgoing) {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message');
                    messageElement.classList.add(isOutgoing ? 'message-outgoing' : 'message-incoming');
                    
                    if (message.message_text) {
                        const contentDiv = document.createElement('div');
                        contentDiv.classList.add('message-content');
                        contentDiv.textContent = message.message_text;
                        messageElement.appendChild(contentDiv);
                    }
                    
                    if (message.has_attachment && message.attachment_url) {
                        const attachmentDiv = document.createElement('div');
                        attachmentDiv.classList.add('message-attachment');
                        
                        const link = document.createElement('a');
                        link.href = message.attachment_url;
                        link.classList.add('btn', 'btn-sm', isOutgoing ? 'btn-outline-light' : 'btn-outline-secondary');
                        link.target = '_blank';
                        
                        const icon = document.createElement('i');
                        icon.classList.add('bi');
                        
                        if (message.attachment_type?.includes('pdf')) {
                            icon.classList.add('bi-file-pdf');
                            icon.style.color = '#dc3545';
                        } else if (message.attachment_type?.includes('word') || message.attachment_type?.includes('doc')) {
                            icon.classList.add('bi-file-word');
                            icon.style.color = '#0d6efd';
                        } else if (message.attachment_type?.includes('excel') || message.attachment_type?.includes('sheet')) {
                            icon.classList.add('bi-file-excel');
                            icon.style.color = '#198754';
                        } else {
                            icon.classList.add('bi-file-earmark');
                        }
                        
                        link.appendChild(icon);
                        
                        const text = document.createTextNode(' ' + (message.attachment_name || 'Attachment'));
                        link.appendChild(text);
                        
                        attachmentDiv.appendChild(link);
                        messageElement.appendChild(attachmentDiv);
                    }
                    
                    const timeElement = document.createElement('div');
                    timeElement.classList.add('message-time');
                    const messageTime = new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    timeElement.textContent = messageTime;
                    messageElement.appendChild(timeElement);
                    
                    if (isOutgoing) {
                        const readStatus = document.createElement('div');
                        readStatus.classList.add('read-status');
                        readStatus.classList.add(message.is_read ? 'read' : 'unread');
                        readStatus.textContent = message.is_read ? 'Read' : 'Delivered';
                        messageElement.appendChild(readStatus);
                    }
                    
                    messagesContainer.appendChild(messageElement);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    lastMessageId = message.id;
                    updateConversationListItem(message);
                }

                // Function to update the conversation list item with the latest message
                function updateConversationListItem(message) {
                    const conversationCard = document.querySelector(`.conversation-card[data-conversation-id="${conversationId}"]`);
                    
                    if (conversationCard) {
                        const lastMessageElement = conversationCard.querySelector('.last-message');
                        if (lastMessageElement) {
                            if (message.message_text) {
                                lastMessageElement.textContent = message.message_text;
                            } else if (message.has_attachment) {
                                if (message.attachment_type && message.attachment_type.startsWith('image/')) {
                                    lastMessageElement.textContent = '📷 Image';
                                } else if (message.attachment_type && message.attachment_type.includes('pdf')) {
                                    lastMessageElement.textContent = '📄 PDF Document';
                                } else if (message.attachment_type && (message.attachment_type.includes('word') || message.attachment_type.includes('doc'))) {
                                    lastMessageElement.textContent = '📝 Document';
                                } else if (message.attachment_type && (message.attachment_type.includes('excel') || message.attachment_type.includes('sheet'))) {
                                    lastMessageElement.textContent = '📊 Spreadsheet';
                                } else {
                                    lastMessageElement.textContent = '📎 File attachment';
                                }
                            }
                        }

                        const timeElement = conversationCard.querySelector('.message-time');
                        if (timeElement) {
                            const now = new Date();
                            timeElement.innerHTML = `<i class="bi bi-clock"></i> ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                        }

                        const listBody = conversationCard.parentElement;
                        if (listBody && listBody.firstChild !== conversationCard) {
                            listBody.insertBefore(conversationCard, listBody.firstChild);
                        }
                    }
                }
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Cleanup Pusher connection when page unloads
                window.addEventListener('beforeunload', function() {
                    pusher.unsubscribe(`conversation-${conversationId}`);
                    pusher.unsubscribe(`user-provider-${providerId}`);
                    pusher.disconnect();
                });
            <% } %>

            // Check for unread messages count
            function checkUnreadCount() {
                fetch('/api/unread-count')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const unreadBadge = document.getElementById('unread-badge');
                            if (data.unreadCount > 0) {
                                unreadBadge.textContent = data.unreadCount;
                                unreadBadge.style.display = 'inline-block';
                            } else {
                                unreadBadge.style.display = 'none';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking unread count:', error);
                    });
            }
            
            setInterval(checkUnreadCount, 30000);
            checkUnreadCount();
        });
    </script>
</body>
</html>