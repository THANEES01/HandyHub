<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HandyHub Admin - Bookings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #0077be;
            --secondary-blue: #00a2e8;
            --dark-blue: #003366;
            --light-blue: #e6f2ff;
        }
 
        .sidebar {
            background-color: var(--dark-blue);
            min-height: 100vh;
            color: white;
        }

        .sidebar nav {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .nav-link.text-danger {
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            margin-top: auto;
            color: #dc3545 !important;
        }
    
        .nav-link.text-danger:hover {
            background-color: rgba(220, 53, 69, 0.1);
            color: #fff !important;
        }
 
        .sidebar .nav-link {
            color: white;
            padding: 15px 20px;
            transition: all 0.3s ease;
        }
 
        .sidebar .nav-link:hover {
            background-color: var(--secondary-blue);
            transform: translateX(10px);
        }
 
        .sidebar .nav-link.active {
            background-color: var(--primary-blue);
            border-left: 4px solid white;
        }
 
        .main-content {
            background-color: #f8f9fa;
        }
 
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
 
        .card-stats {
            background: white;
            transition: transform 0.3s;
        }
 
        .card-stats:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
 
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            margin-top: 30px;
        }
 
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-confirmed {
            background-color: #d1e7dd;
            color: #0f5132;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-completed {
            background-color: #cfe2ff;
            color: #084298;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-cancelled {
            background-color: #f8d7da;
            color: #842029;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
 
        .info-section {
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            background: var(--light-blue);
        }
 
        .service-tag {
            background: white;
            color: var(--dark-blue);
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
 
        .stats-icon {
            font-size: 2.5rem;
            color: var(--primary-blue);
            margin-bottom: 15px;
        }
 
        .table thead th {
            background-color: var(--light-blue);
            color: var(--dark-blue);
            padding: 15px;
            font-weight: 600;
        }
 
        .table tbody td {
            padding: 15px;
            vertical-align: middle;
        }
 
        .btn-primary {
            background-color: var(--primary-blue);
            border: none;
            padding: 8px 20px;
            transition: all 0.3s ease;
        }
 
        .btn-primary:hover {
            background-color: var(--dark-blue);
            transform: translateY(-2px);
        }

        .modal-content {
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .modal-header {
            background-color: #0077be;
            color: white;
            border-bottom: none;
            padding: 1.5rem;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }

        .modal-body {
            padding: 2rem;
        }

        .booking-stats-card {
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .booking-stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .booking-stats-icon {
            font-size: 2.2rem;
            padding: 15px;
            border-radius: 50%;
            margin-bottom: 10px;
            display: inline-block;
        }

        .pending-icon {
            background-color: #fff3cd;
            color: #856404;
        }

        .confirmed-icon {
            background-color: #d1e7dd;
            color: #0f5132;
        }

        .completed-icon {
            background-color: #cfe2ff;
            color: #084298;
        }

        .cancelled-icon {
            background-color: #f8d7da;
            color: #842029;
        }

        .payment-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .payment-paid {
            background-color: #d1e7dd;
            color: #0f5132;
        }

        .payment-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .payment-refunded {
            background-color: #cfe2ff;
            color: #084298;
        }

        .filters-container {
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        .date-range-picker {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px 15px;
        }

        .booking-details-container h5 {
            color: var(--dark-blue);
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .booking-detail-row {
            margin-bottom: 15px;
        }

        .booking-property {
            font-weight: 600;
            color: var(--dark-blue);
        }

        .image-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .booking-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .booking-image:hover {
            transform: scale(1.05);
        }

        #imageModal img {
            max-width: 100%;
            max-height: 80vh;
        }

        .status-update-form {
            background-color: var(--light-blue);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            min-width: 250px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .modal-danger .modal-content {
            animation: pulse 1s;
        }

    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 px-0 sidebar">
            <div class="p-4">
                <h4>HandyHub Admin</h4>
            </div>
            <nav class="nav flex-column">
                <a class="nav-link" href="/admin/dashboard">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a class="nav-link" href="/admin/service-providers">
                    <i class="bi bi-people"></i> Service Providers
                </a>
                <a class="nav-link" href="/admin/customers">
                    <i class="bi bi-person"></i> Customers
                </a>
                <a class="nav-link active" href="/admin/bookings">
                    <i class="bi bi-calendar"></i> Bookings
                </a>
                <a class="nav-link" href="/admin/earnings">
                    <i class="bi bi-cash"></i> Earnings
                </a>
                <!-- Add this at the bottom of the nav -->
                <div class="mt-auto">
                    <button onclick="logout()" class="nav-link text-danger">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="col-md-10 main-content p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Booking Management</h2>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="exportData()">
                        <i class="bi bi-download"></i> Export Data
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#filtersContainer">
                        <i class="bi bi-funnel"></i> Filters
                    </button>
                </div>
            </div>

            <!-- Booking Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card booking-stats-card">
                        <div class="card-body text-center">
                            <div class="booking-stats-icon pending-icon">
                                <i class="bi bi-hourglass-split"></i>
                            </div>
                            <h5 class="card-title">Pending</h5>
                            <h2 class="card-text"><%= pendingBookings %></h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card booking-stats-card">
                        <div class="card-body text-center">
                            <div class="booking-stats-icon confirmed-icon">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <h5 class="card-title">Confirmed</h5>
                            <h2 class="card-text"><%= confirmedBookings %></h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card booking-stats-card">
                        <div class="card-body text-center">
                            <div class="booking-stats-icon completed-icon">
                                <i class="bi bi-trophy"></i>
                            </div>
                            <h5 class="card-title">Completed</h5>
                            <h2 class="card-text"><%= completedBookings %></h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card booking-stats-card">
                        <div class="card-body text-center">
                            <div class="booking-stats-icon cancelled-icon">
                                <i class="bi bi-x-circle"></i>
                            </div>
                            <h5 class="card-title">Cancelled</h5>
                            <h2 class="card-text"><%= cancelledBookings %></h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="collapse mb-4" id="filtersContainer">
                <div class="filters-container">
                    <h5 class="mb-3">Filter Bookings</h5>
                    <form id="filterForm" action="/admin/bookings" method="GET">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="statusFilter" class="form-label">Status</label>
                                <select class="form-select" id="statusFilter" name="status">
                                    <option value="">All Statuses</option>
                                    <option value="Pending" <%= filter && filter.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                                    <option value="Confirmed" <%= filter && filter.status === 'Confirmed' ? 'selected' : '' %>>Confirmed</option>
                                    <option value="Completed" <%= filter && filter.status === 'Completed' ? 'selected' : '' %>>Completed</option>
                                    <option value="Cancelled" <%= filter && filter.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="paymentFilter" class="form-label">Payment Status</label>
                                <select class="form-select" id="paymentFilter" name="paymentStatus">
                                    <option value="">All Payment Statuses</option>
                                    <option value="Paid" <%= filter && filter.paymentStatus === 'Paid' ? 'selected' : '' %>>Paid</option>
                                    <option value="Pending" <%= filter && filter.paymentStatus === 'Pending' ? 'selected' : '' %>>Pending</option>
                                    <option value="Refunded" <%= filter && filter.paymentStatus === 'Refunded' ? 'selected' : '' %>>Refunded</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="dateFrom" class="form-label">Date From</label>
                                <input type="date" class="form-control" id="dateFrom" name="dateFrom" value="<%= filter && filter.dateFrom ? filter.dateFrom : '' %>">
                            </div>
                            <div class="col-md-3">
                                <label for="dateTo" class="form-label">Date To</label>
                                <input type="date" class="form-control" id="dateTo" name="dateTo" value="<%= filter && filter.dateTo ? filter.dateTo : '' %>">
                            </div>
                            <div class="col-md-4">
                                <label for="serviceType" class="form-label">Service Type</label>
                                <select class="form-select" id="serviceType" name="serviceType">
                                    <option value="">All Service Types</option>
                                    <% serviceTypes.forEach(function(type) { %>
                                        <option value="<%= type %>" <%= filter && filter.serviceType === type ? 'selected' : '' %>><%= type %></option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="providerId" class="form-label">Service Provider</label>
                                <select class="form-select" id="providerId" name="providerId">
                                    <option value="">All Providers</option>
                                    <% providers.forEach(function(provider) { %>
                                        <option value="<%= provider.id %>" <%= filter && filter.providerId == provider.id ? 'selected' : '' %>><%= provider.business_name %></option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="searchTerm" class="form-label">Search</label>
                                <input type="text" class="form-control" id="searchTerm" name="searchTerm" placeholder="Search by name, email, etc." value="<%= filter && filter.searchTerm ? filter.searchTerm : '' %>">
                            </div>
                            <div class="col-12 d-flex justify-content-end">
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="resetFilters()">Reset</button>
                                <button type="submit" class="btn btn-primary">Apply Filters</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Bookings Table -->
            <div class="card mt-4">
                <div class="card-body">
                    <h4 class="card-title mb-4">All Bookings</h4>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Customer</th>
                                    <th>Service Provider</th>
                                    <th>Service Type</th>
                                    <th>Date & Time</th>
                                    <th>Status</th>
                                    <th>Payment</th>
                                    <th>Booked On</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (bookings && bookings.length > 0) { %>
                                    <% bookings.forEach(function(booking) { %>
                                        <tr>
                                            <td>#<%= booking.id %></td>
                                            <td><%= booking.customer_name %></td>
                                            <td><%= booking.provider_name %></td>
                                            <td><%= booking.service_type %></td>
                                            <td>
                                                <%= new Date(booking.preferred_date).toLocaleDateString() %><br>
                                                <small class="text-muted"><%= booking.time_slot %></small>
                                            </td>
                                            <td>
                                                <% if (booking.status === 'Pending') { %>
                                                    <span class="badge status-pending">Pending</span>
                                                <% } else if (booking.status === 'Confirmed') { %>
                                                    <span class="badge status-confirmed">Confirmed</span>
                                                <% } else if (booking.status === 'Completed') { %>
                                                    <span class="badge status-completed">Completed</span>
                                                <% } else if (booking.status === 'Cancelled') { %>
                                                    <span class="badge status-cancelled">Cancelled</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <% if (booking.payment_status === 'Paid') { %>
                                                    <span class="badge payment-badge payment-paid">Paid</span>
                                                <% } else if (booking.payment_status === 'Pending') { %>
                                                    <span class="badge payment-badge payment-pending">Pending</span>
                                                <% } else if (booking.payment_status === 'Refunded') { %>
                                                    <span class="badge payment-badge payment-refunded">Refunded</span>
                                                <% } %>
                                            </td>
                                            <td><%= new Date(booking.created_at).toLocaleDateString() %></td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn btn-sm btn-primary" onclick="viewBookingDetails('<%= booking.id %>')">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteBooking('<%= booking.id %>')">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="9" class="text-center py-5">
                                            <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                                            <p class="mt-3 mb-0">No bookings found</p>
                                            <% if (filter) { %>
                                                <p class="text-muted">Try adjusting your filters</p>
                                                <button class="btn btn-outline-primary" onclick="resetFilters()">Reset Filters</button>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <% if (totalPages > 1) { %>
                        <nav aria-label="Bookings pagination" class="mt-4">
                            <ul class="pagination justify-content-center">
                                <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                                    <a class="page-link" href="?page=<%= currentPage - 1 %><%= paginationQuery %>" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <% for (let i = 1; i <= totalPages; i++) { %>
                                    <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                        <a class="page-link" href="?page=<%= i %><%= paginationQuery %>"><%= i %></a>
                                    </li>
                                <% } %>
                                <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                    <a class="page-link" href="?page=<%= currentPage + 1 %><%= paginationQuery %>" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Details Modal -->
<div class="modal fade" id="bookingDetailsModal" tabindex="-1" aria-labelledby="bookingDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingDetailsModalLabel">Booking Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="booking-details-container">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Booking Information</h5>
                            <div class="booking-detail-row">
                                <span class="booking-property">Booking ID:</span>
                                <span id="bookingId"></span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-property">Service Type:</span>
                                <span id="bookingServiceType"></span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-property">Booking Date:</span>
                                <span id="bookingDate"></span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-property">Time Slot:</span>
                                <span id="bookingTimeSlot"></span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-property">Status:</span>
                                <span id="bookingStatus"></span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-property">Created On:</span>
                                <span id="bookingCreatedDate"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Payment Information</h5>
                            <div class="booking-detail-row">
                                <span class="booking-property">Payment Status:</span>
                                <span id="paymentStatus"></span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-property">Base Fee:</span>
                                <span id="baseFee"></span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-property">Fee Type:</span>
                                <span id="feeType"></span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-property">Payment Method:</span>
                                <span id="paymentMethod"></span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-property">Payment Reference:</span>
                                <span id="paymentReference"></span>
                            </div>
                        </div>
                    </div>

                    <h5 class="mt-4">Customer Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="booking-detail-row">
                                <span class="booking-property">Name:</span>
                                <span id="customerName"></span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-property">Email:</span>
                                <span id="customerEmail"></span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-property">Phone:</span>
                                <span id="customerPhone"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="booking-detail-row">
                                <span class="booking-property">Address:</span>
                                <span id="serviceAddress"></span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-property">Access Instructions:</span>
                                <span id="accessInstructions"></span>
                            </div>
                        </div>
                    </div>

                    <h5 class="mt-4">Service Provider</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="booking-detail-row">
                                <span class="booking-property">Business Name:</span>
                                <span id="providerName"></span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-property">Contact:</span>
                                <span id="providerContact"></span>
                            </div>
                        </div>
                    </div>

                    <h5 class="mt-4">Service Details</h5>
                    <div class="booking-detail-row">
                        <span class="booking-property">Issue Description:</span>
                        <div id="issueDescription" class="mt-2 p-3 bg-light rounded"></div>
                    </div>

                    <!-- Images -->
                    <div id="imagesContainer">
                        <h5 class="mt-4">Images</h5>
                        <div id="imageGallery" class="image-gallery">
                            <!-- Images will be inserted here dynamically -->
                        </div>
                    </div>

                    <!-- Status Update Form -->
                    <div class="status-update-form">
                        <h5 class="mb-3">Update Status</h5>
                        <form id="updateStatusForm">
                            <input type="hidden" id="bookingIdInput" name="bookingId">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="statusUpdate" class="form-label">Booking Status</label>
                                    <select class="form-select" id="statusUpdate" name="status">
                                        <option value="Pending">Pending</option>
                                        <option value="Confirmed">Confirmed</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="paymentStatusUpdate" class="form-label">Payment Status</label>
                                    <select class="form-select" id="paymentStatusUpdate" name="paymentStatus">
                                        <option value="Pending">Pending</option>
                                        <option value="Paid">Paid</option>
                                        <option value="Refunded">Refunded</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="paymentStatusUpdate" class="form-label">Payment Status</label>
                                    <select class="form-select" id="paymentStatusUpdate" name="paymentStatus">
                                        <option value="Pending">Pending</option>
                                        <option value="Paid">Paid</option>
                                        <option value="Refunded">Refunded</option>
                                    </select>
                                </div>
                                <div class="col-12 mt-4">
                                    <button type="button" class="btn btn-primary" onclick="updateBookingStatus()">
                                        Update Status
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="Booking Image" class="img-fluid">
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete booking <strong id="bookingIdToDelete"></strong>?</p>
                <p class="text-danger">This action cannot be undone. All associated data including payment information will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div class="toast-container">
    <div class="toast" id="statusToast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Status updated successfully!
        </div>
    </div>
</div>

<script>
    let currentBookingId = null;
    
    // Function to view booking details
    function viewBookingDetails(id) {
        currentBookingId = id;
        
        // Fetch booking details from the server
        fetch(`/admin/booking/${id}/details`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(booking => {
                console.log('Booking details received:', booking);
                
                // Set booking information
                document.getElementById('bookingId').textContent = '#' + booking.id;
                document.getElementById('bookingServiceType').textContent = booking.service_type || 'N/A';
                document.getElementById('bookingDate').textContent = new Date(booking.preferred_date).toLocaleDateString();
                document.getElementById('bookingTimeSlot').textContent = booking.time_slot || 'N/A';
                
                // Set status with appropriate styling
                const statusSpan = document.getElementById('bookingStatus');
                statusSpan.textContent = booking.status || 'N/A';
                statusSpan.className = '';
                if (booking.status === 'Pending') {
                    statusSpan.classList.add('badge', 'status-pending');
                } else if (booking.status === 'Confirmed') {
                    statusSpan.classList.add('badge', 'status-confirmed');
                } else if (booking.status === 'Completed') {
                    statusSpan.classList.add('badge', 'status-completed');
                } else if (booking.status === 'Cancelled') {
                    statusSpan.classList.add('badge', 'status-cancelled');
                }
                
                document.getElementById('bookingCreatedDate').textContent = 
                    booking.created_at ? new Date(booking.created_at).toLocaleString() : 'N/A';
                
                // Set payment information
                const paymentStatusSpan = document.getElementById('paymentStatus');
                paymentStatusSpan.textContent = booking.payment_status || 'N/A';
                paymentStatusSpan.className = '';
                if (booking.payment_status === 'Paid') {
                    paymentStatusSpan.classList.add('badge', 'payment-badge', 'payment-paid');
                } else if (booking.payment_status === 'Pending') {
                    paymentStatusSpan.classList.add('badge', 'payment-badge', 'payment-pending');
                } else if (booking.payment_status === 'Refunded') {
                    paymentStatusSpan.classList.add('badge', 'payment-badge', 'payment-refunded');
                }
                
                document.getElementById('baseFee').textContent = booking.base_fee ? 
                    'RM' + parseFloat(booking.base_fee).toFixed(2) : 'N/A';
                document.getElementById('feeType').textContent = booking.fee_type || 'N/A';
                document.getElementById('paymentMethod').textContent = booking.payment_method || 'N/A';
                document.getElementById('paymentReference').textContent = booking.payment_reference || 'N/A';
                
                // Set customer information
                document.getElementById('customerName').textContent = booking.customer_name || 'N/A';
                document.getElementById('customerEmail').textContent = booking.customer_email || 'N/A';
                document.getElementById('customerPhone').textContent = booking.customer_phone || 'N/A';
                document.getElementById('serviceAddress').textContent = booking.service_address || 'N/A';
                document.getElementById('accessInstructions').textContent = booking.access_instructions || 'None provided';
                
                // Set provider information
                document.getElementById('providerName').textContent = booking.provider_name || 'N/A';
                document.getElementById('providerContact').textContent = booking.provider_contact || 'N/A';
                
                // Set issue description
                document.getElementById('issueDescription').textContent = booking.issue_description || 'No description provided';
                
                // Set up images if available
                const imageGallery = document.getElementById('imageGallery');
                imageGallery.innerHTML = '';
                
                const imagesContainer = document.getElementById('imagesContainer');
                
                if (booking.images && booking.images.length > 0) {
                    imagesContainer.style.display = 'block';
                    
                    try {
                        let imageUrls = [];
                        if (typeof booking.images === 'string') {
                            imageUrls = JSON.parse(booking.images);
                        } else {
                            imageUrls = booking.images;
                        }
                        
                        if (Array.isArray(imageUrls) && imageUrls.length > 0) {
                            imageUrls.forEach(url => {
                                const imgContainer = document.createElement('div');
                                
                                const img = document.createElement('img');
                                img.src = url;
                                img.alt = 'Booking Image';
                                img.className = 'booking-image';
                                img.onclick = function() { showImageModal(url); };
                                
                                imgContainer.appendChild(img);
                                imageGallery.appendChild(imgContainer);
                            });
                        } else {
                            imageGallery.innerHTML = '<p class="text-muted">No images available</p>';
                        }
                    } catch (e) {
                        console.error('Error parsing images:', e);
                        imageGallery.innerHTML = '<p class="text-muted">Error loading images</p>';
                    }
                } else {
                    imagesContainer.style.display = 'none';
                }
                
                // Set form values for status update
                document.getElementById('bookingIdInput').value = booking.id;
                document.getElementById('statusUpdate').value = booking.status || 'Pending';
                document.getElementById('paymentStatusUpdate').value = booking.payment_status || 'Pending';
                
                // Show the modal
                new bootstrap.Modal(document.getElementById('bookingDetailsModal')).show();
            })
            .catch(error => {
                console.error('Error fetching booking details:', error);
                alert('Error loading booking details. Please try again.');
            });
    }
    
    // Function to show image in modal
    function showImageModal(imageUrl) {
        const modalImage = document.getElementById('modalImage');
        modalImage.src = imageUrl;
        
        new bootstrap.Modal(document.getElementById('imageModal')).show();
    }
    
    // Function to confirm booking deletion
    function confirmDeleteBooking(id) {
        document.getElementById('bookingIdToDelete').textContent = '#' + id;
        
        // Set up the delete button handler
        document.getElementById('confirmDeleteBtn').onclick = function() {
            deleteBooking(id);
        };
        
        // Show the confirmation modal
        new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
    }
    
    // Function to delete booking
    function deleteBooking(id) {
        fetch(`/admin/booking/${id}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                // Close the modal
                bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
                
                // Show success message
                showToast('Booking deleted successfully');
                
                // Reload the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                throw new Error(result.error || 'Failed to delete booking');
            }
        })
        .catch(error => {
            console.error('Error deleting booking:', error);
            alert(`Error: ${error.message}`);
        });
    }
    
    // Function to update booking status
    function updateBookingStatus() {
        const bookingId = document.getElementById('bookingIdInput').value;
        const status = document.getElementById('statusUpdate').value;
        const paymentStatus = document.getElementById('paymentStatusUpdate').value;
        
        fetch(`/admin/booking/${bookingId}/update-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status,
                paymentStatus
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                // Close the modal
                bootstrap.Modal.getInstance(document.getElementById('bookingDetailsModal')).hide();
                
                // Show success message
                showToast('Booking status updated successfully');
                
                // Reload the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                throw new Error(result.error || 'Failed to update booking status');
            }
        })
        .catch(error => {
            console.error('Error updating booking status:', error);
            alert(`Error: ${error.message}`);
        });
    }
    
    // Function to show toast message
    function showToast(message) {
        const toast = document.getElementById('statusToast');
        document.getElementById('toastMessage').textContent = message;
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }
    
    // Function to export booking data
    function exportData() {
        // Get current filter parameters
        const urlParams = new URLSearchParams(window.location.search);
        
        // Create export URL with current filters
        let exportUrl = '/admin/bookings/export';
        if (urlParams.toString()) {
            exportUrl += '?' + urlParams.toString();
        }
        
        // Redirect to export URL
        window.location.href = exportUrl;
    }
    
    // Function to reset filters
    function resetFilters() {
        document.getElementById('filterForm').reset();
        document.getElementById('filterForm').submit();
    }
    
    // Function to handle logout
    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            window.location.href = '/auth/logout';
        }
    }
    
    // Initialize tooltips when document is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Enable tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
